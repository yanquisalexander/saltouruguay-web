---
import MenuIcon from "@/icons/MenuIcon.astro";
import type { Session } from "@auth/core/types";
import { CurrentUser } from "./CurrentUser";
import DiscordPresenceCount from "./DiscordPresenceCount";
import { Notifications } from "./Notifications";
import { LucideLock } from "lucide-preact";
import { CHRISTMAS_MODE } from "@/config"; //  Importamos la config

interface Props {
  session?: Session | null;
  hideNav?: boolean;
}

const PRERENDERED_PATHS = [
  "/",
  "/privacidad",
  "/terminos",
  "/awards",
  "/saltocraft",
  "/acreconre",
];

const currentPath = Astro.url.pathname;
const { session, hideNav } = Astro.props;

const links = [
  { label: "Comunidad", url: "/comunidad" },
  { label: "Torneos", url: "/torneos" },
  { label: "Eventos", url: "/eventos", soon: false, specialComment: "NUEVO" },
  { label: "Awards", url: "/awards", specialComment: "VOTACIN" },
];

const isPrerenderedPath = PRERENDERED_PATHS.includes(currentPath);
const evenLinks = links.filter((_, index) => index % 2 === 0);
const oddLinks = links.filter((_, index) => index % 2 !== 0);

// --- ESTILOS CONDICIONALES ---

const navLinkBase =
  "relative flex flex-col items-center justify-center px-4 py-1 group transition-all duration-300";
const textStyle =
  "font-teko text-xl uppercase tracking-wide transition-colors relative z-10";

// L贸gica de colores (Navidad vs Default)
const activeText = CHRISTMAS_MODE
  ? "text-red-400 drop-shadow-[0_0_8px_rgba(248,113,113,0.5)]" // Rojo Navidad
  : "text-yellow-400 drop-shadow-[0_0_8px_rgba(234,179,8,0.5)]"; // Amarillo Default

const inactiveText = "text-white/70 group-hover:text-white";

// L贸gica de la l铆nea inferior (Underline)
const underlineColor = CHRISTMAS_MODE
  ? "bg-gradient-to-r from-green-500 via-red-500 to-green-500" // Bast贸n de caramelo
  : "bg-yellow-500";

const logoGlowColor = CHRISTMAS_MODE ? "bg-red-500/30" : "bg-yellow-500/20";

// Helper para generar las clases del Badge seg煤n el tipo de mensaje
const getBadgeStyles = (label: string) => {
  const base =
    "absolute -top-3.5 left-1/2 -translate-x-1/2 text-[9px] font-bold font-rubik px-2 py-0.5 rounded-full border shadow-[0_0_10px_rgba(0,0,0,0.5)] tracking-widest leading-none whitespace-nowrap transition-transform duration-300 group-hover:-translate-y-1 pointer-events-none backdrop-blur-md z-20";

  // Si es navidad, forzamos colores navide帽os en etiquetas espec铆ficas
  if (
    CHRISTMAS_MODE &&
    (label.includes("VOTA") || label.includes("VOTACIN"))
  ) {
    return `${base} bg-green-600/30 text-green-300 border-green-500/40 shadow-green-500/10`;
  }

  if (label.includes("VOTA") || label.includes("VOTACIN")) {
    return `${base} bg-yellow-500/20 text-yellow-300 border-yellow-500/40 shadow-yellow-500/10`;
  }
  if (label.includes("NUEVO") || label.includes("ATENTOS")) {
    return `${base} bg-cyan-500/20 text-cyan-300 border-cyan-500/40 shadow-cyan-500/10`;
  }
  return `${base} bg-white/10 text-white/80 border-white/20`;
};
---

{
  !hideNav && (
    <>
      <header
        id="site-header"
        class="fixed top-0 left-0 right-0 z-50 w-full transition-all duration-300 py-6"
      >
        {/* LA ISLA FLOTANTE */}
        <div
          id="nav-island"
          class="mx-auto flex items-center justify-between px-4 md:px-6 py-2 transition-all duration-300 w-[95%] max-w-7xl rounded-full border border-transparent"
        >
          {/* --- IZQUIERDA --- */}
          <div class="flex items-center flex-1 gap-4">
            {/* Logo M贸vil */}
            <a
              href="/"
              class="md:hidden block transition-transform hover:scale-105"
            >
              <img
                src="/favicon.svg"
                alt="Logo"
                class="size-10 object-contain"
              />
            </a>

            {/* Nav Escritorio (Izquierda) */}
            <nav class="hidden md:flex items-center gap-1 gap-x-4 ml-auto mr-4">
              {evenLinks.map((link) =>
                link.soon ? (
                  <div class={`${navLinkBase} opacity-50 cursor-not-allowed`}>
                    <span class={textStyle}>{link.label}</span>
                    <LucideLock
                      size={12}
                      class="absolute top-1 -right-2 text-white/30"
                    />
                  </div>
                ) : (
                  <a href={link.url} class={navLinkBase}>
                    <span
                      class={`${textStyle} ${currentPath.startsWith(link.url) ? activeText : inactiveText}`}
                    >
                      {link.label}
                    </span>

                    {/* SPECIAL LABEL MEJORADO */}
                    {link.specialComment && (
                      <span class={getBadgeStyles(link.specialComment)}>
                        {link.specialComment}
                      </span>
                    )}

                    {/* Underline animado */}
                    <span
                      class={`absolute bottom-0 left-1/2 -translate-x-1/2 h-[2px] ${underlineColor} rounded-full transition-all duration-300 ${currentPath.startsWith(link.url) ? "w-full opacity-100 shadow-[0_0_10px_currentColor]" : "w-0 opacity-0 group-hover:w-2/3 group-hover:opacity-100"}`}
                    />
                  </a>
                )
              )}
            </nav>
          </div>

          {/* --- CENTRO (Logo Escritorio) --- */}
          {/* A帽adimos clase condicional para el gorro */}
          <div
            class={`hidden md:flex flex-shrink-0 mx-4 relative group ${CHRISTMAS_MODE ? "christmas-logo-nav" : ""}`}
          >
            <a
              href="/"
              id="home-button"
              class="block transition-transform duration-300 group-hover:scale-110 active:scale-95"
            >
              <div
                class={`absolute inset-0 ${logoGlowColor} blur-xl rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300`}
              />
              <img
                src="/favicon.svg"
                alt="Home"
                class="size-14 object-contain relative z-10 drop-shadow-[0_4px_6px_rgba(0,0,0,0.3)]"
              />
            </a>
          </div>

          {/* --- DERECHA --- */}
          <div class="flex items-center flex-1 gap-4">
            {/* Nav Escritorio (Derecha) */}
            <nav class="hidden md:flex items-center gap-1 gap-x-4 mr-auto ml-4">
              {oddLinks.map((link) =>
                link.soon ? (
                  <div class={`${navLinkBase} opacity-50 cursor-not-allowed`}>
                    <span class={textStyle}>{link.label}</span>
                    <LucideLock
                      size={12}
                      class="absolute top-1 -right-2 text-white/30"
                    />
                  </div>
                ) : (
                  <a href={link.url} class={navLinkBase}>
                    <span
                      class={`${textStyle} ${currentPath.startsWith(link.url) ? activeText : inactiveText}`}
                    >
                      {link.label}
                    </span>

                    {/* SPECIAL LABEL MEJORADO */}
                    {link.specialComment && (
                      <span class={getBadgeStyles(link.specialComment)}>
                        {link.specialComment}
                      </span>
                    )}

                    <span
                      class={`absolute bottom-0 left-1/2 -translate-x-1/2 h-[2px] ${underlineColor} rounded-full transition-all duration-300 ${currentPath.startsWith(link.url) ? "w-full opacity-100 shadow-[0_0_10px_currentColor]" : "w-0 opacity-0 group-hover:w-2/3 group-hover:opacity-100"}`}
                    />
                  </a>
                )
              )}
            </nav>

            {/* HERRAMIENTAS */}
            <div class="flex items-center gap-2 ml-auto md:pl-4 md:border-l border-white/10">
              <div class="hidden md:block opacity-80 hover:opacity-100 transition-opacity">
                <DiscordPresenceCount
                  client:idle
                  transition:persist
                  transition:name="discord-widget-count"
                />
              </div>
              <div class="opacity-80 hover:opacity-100 transition-opacity">
                <Notifications
                  client:load
                  transition:persist
                  transition:name="notifications"
                />
              </div>
              <div class="relative z-50">
                <CurrentUser
                  user={session?.user || null}
                  isPrerenderedPath={isPrerenderedPath}
                  client:load
                  transition:persist
                  transition:name="current-user"
                />
              </div>
              <button
                id="mobile-menu-btn"
                class="md:hidden p-2 text-white/80 bg-white/5 hover:bg-white/10 rounded-full ml-1 transition-colors"
              >
                <MenuIcon class="size-5" />
              </button>
            </div>
          </div>
        </div>
      </header>

      {/* --- MENU MVIL --- */}
      <div
        id="mobile-drawer"
        class="fixed inset-0 z-[40] hidden pointer-events-none"
      >
        <div
          id="drawer-bg"
          class="absolute inset-0 bg-black/80 backdrop-blur-sm opacity-0 transition-opacity duration-300 pointer-events-auto"
        />

        <nav
          id="drawer-panel"
          class="absolute top-0 right-0 h-full w-[80%] max-w-xs bg-[#0a0a0a] border-l border-white/10 shadow-2xl transform translate-x-full transition-transform duration-300 pointer-events-auto pt-24 flex flex-col"
        >
          <div class="px-6 flex justify-between items-center mb-6">
            <span class="font-teko text-xl text-white/50 tracking-widest">
              NAVEGACIN
            </span>
            <button
              id="close-drawer"
              class="text-white/50 hover:text-white p-2"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>

          <div class="flex-1 overflow-y-auto px-4 space-y-2">
            <a
              href="/"
              class={`block px-4 py-3 rounded-lg font-teko text-xl transition-colors ${currentPath === "/" ? (CHRISTMAS_MODE ? "bg-red-500/10 text-red-400" : "bg-yellow-500/10 text-yellow-400") : "bg-white/5 text-white hover:bg-white/10"}`}
            >
              INICIO
            </a>
            {links.map((link) =>
              link.soon ? (
                <div class="block px-4 py-3 text-white/30 font-teko text-xl flex justify-between cursor-not-allowed">
                  {link.label} <LucideLock size={16} />
                </div>
              ) : (
                <a
                  href={link.url}
                  class={`block px-4 py-3 rounded-lg font-teko text-xl flex justify-between transition-colors ${currentPath.startsWith(link.url) ? (CHRISTMAS_MODE ? "bg-red-500/10 text-red-400" : "bg-yellow-500/10 text-yellow-400") : "text-white/70 hover:bg-white/5 hover:text-white"}`}
                >
                  {link.label}
                  {link.specialComment && (
                    <span
                      class={`text-[10px] font-rubik font-bold px-2 py-0.5 rounded tracking-wide ${link.specialComment === "VOTACIN" ? (CHRISTMAS_MODE ? "bg-red-500/20 text-red-400" : "bg-yellow-500/20 text-yellow-400") : "bg-blue-500/20 text-blue-400"}`}
                    >
                      {link.specialComment}
                    </span>
                  )}
                </a>
              )
            )}
            <div class="mt-4 pt-4 border-t border-white/10 px-4">
              <DiscordPresenceCount client:visible />
            </div>
          </div>
        </nav>
      </div>
    </>
  )
}

<style>
  /* ESTILOS ACTIVOS POR JS (SCROLL) */
  :global(#site-header.is-scrolled) {
    @apply py-2;
  }

  :global(#site-header.is-scrolled #nav-island) {
    @apply bg-[#050505]/85 backdrop-blur-xl border-white/10 shadow-2xl max-w-6xl;
  }

  /*  GORRO DE NAVIDAD (CSS PURO) */
  /* Se ajusta espec铆ficamente para el logo peque帽o del Navbar */
  .christmas-logo-nav::before {
    content: "";
    position: absolute;
    top: -18px;
    left: -8px;
    font-size: 2rem;
    z-index: 50;
    transform: rotate(-15deg);
    animation: bounceHatNav 3s infinite ease-in-out;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
    pointer-events: none; /* Para que no moleste el click al logo */
  }

  @keyframes bounceHatNav {
    0%,
    100% {
      transform: rotate(-15deg) translateY(0);
    }
    50% {
      transform: rotate(-5deg) translateY(-3px);
    }
  }
</style>

<script>
  import { $ } from "@/lib/dom-selector";

  document.addEventListener("astro:page-load", () => {
    const header = $("#site-header");
    const mobileBtn = $("#mobile-menu-btn");
    const closeBtn = $("#close-drawer");
    const drawer = $("#mobile-drawer");
    const drawerBg = $("#drawer-bg");
    const drawerPanel = $("#drawer-panel");
    const body = document.body;

    // 1. L贸gica de Scroll
    const handleScroll = () => {
      if (window.scrollY > 20) {
        header?.classList.add("is-scrolled");
      } else {
        header?.classList.remove("is-scrolled");
      }
    };
    window.addEventListener("scroll", handleScroll, { passive: true });
    handleScroll();

    // 2. L贸gica de Men煤 M贸vil
    const openMenu = () => {
      drawer?.classList.remove("hidden");
      setTimeout(() => {
        drawerBg?.classList.remove("opacity-0");
        drawerPanel?.classList.remove("translate-x-full");
      }, 10);
      body.style.overflow = "hidden";
    };

    const closeMenu = () => {
      drawerBg?.classList.add("opacity-0");
      drawerPanel?.classList.add("translate-x-full");
      setTimeout(() => {
        drawer?.classList.add("hidden");
        body.style.overflow = "";
      }, 300);
    };

    mobileBtn?.addEventListener("click", openMenu);
    closeBtn?.addEventListener("click", closeMenu);
    drawerBg?.addEventListener("click", closeMenu);
  });
</script>
