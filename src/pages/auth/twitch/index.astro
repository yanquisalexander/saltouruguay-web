---
import Layout from "@/layouts/Layout.astro";
import { getSession } from "auth-astro/server";
import { LucideLoader2, LucideArrowRight } from "lucide-preact";

const session = await getSession(Astro.request);

if (session) {
  return Astro.redirect("/");
}
---

<Layout
  title="Iniciando sesión..."
  hideHeader
  hideFooter
  mainClassname="flex flex-col items-center justify-center min-h-dvh w-full relative overflow-hidden"
>
  {/* Fondo Ambiental */}
  <div class="fixed inset-0 -z-10 bg-[#050505]">
    <div
      class="absolute inset-0 bg-[url('/images/pattern-grid.svg')] opacity-[0.03]"
    >
    </div>
    <div
      class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-purple-900/10 blur-[150px] rounded-full pointer-events-none"
    >
    </div>
  </div>

  {/* Contenedor de la Tarjeta */}
  <div class="w-full max-w-md p-4 animate-in fade-in zoom-in-95 duration-500">
    {/* Tarjeta de Conexión */}
    <div
      class="relative bg-[#0a0a0a] border border-white/10 rounded-3xl p-8 shadow-2xl shadow-purple-900/20 overflow-hidden"
    >
      {/* Efecto de carga superior */}
      <div class="absolute top-0 left-0 h-1 w-full bg-white/5 overflow-hidden">
        <div class="h-full bg-purple-500 animate-loading-bar"></div>
      </div>

      {/* Visualización de Conexión */}
      <div class="flex items-center justify-between mb-8 px-4">
        {/* Logo Salto */}
        <div class="relative group">
          <div
            class="absolute inset-0 bg-blue-500/20 blur-xl rounded-full opacity-50 group-hover:opacity-80 transition-opacity"
          >
          </div>
          <img
            src="/favicon.svg"
            alt="SaltoUruguayServer"
            class="relative size-16 object-contain drop-shadow-lg"
          />
        </div>

        {/* Flechas Animadas */}
        <div class="flex flex-col items-center gap-1 text-white/20">
          <div class="flex gap-1 animate-pulse">
            <div class="size-1.5 rounded-full bg-purple-500"></div>
            <div class="size-1.5 rounded-full bg-purple-500/50"></div>
            <div class="size-1.5 rounded-full bg-purple-500/20"></div>
          </div>
          <LucideArrowRight size={20} class="text-purple-500/50" />
        </div>

        {/* Logo Twitch (Imagen Original) */}
        <div class="relative group">
          <div
            class="absolute inset-0 bg-purple-500/20 blur-xl rounded-full opacity-50 group-hover:opacity-80 transition-opacity"
          >
          </div>
          <img
            src="/twitch-icon.png"
            alt="Twitch"
            class="relative size-16 object-contain drop-shadow-lg"
          />
        </div>
      </div>

      {/* Textos */}
      <div class="text-center space-y-3">
        <h1
          class="text-2xl font-anton text-white uppercase tracking-wide flex items-center justify-center gap-2"
        >
          <LucideLoader2 size={24} class="animate-spin text-purple-500" />
          Conectando...
        </h1>

        <div class="space-y-1">
          <p class="text-white/80 font-bold text-sm">
            Solicitando acceso a Twitch
          </p>
          <p
            class="text-white/40 text-xs font-rubik max-w-xs mx-auto leading-relaxed"
          >
            Con tu cuenta podrás acceder a los beneficios exclusivos, votar en
            los premios y participar en la comunidad.
          </p>
        </div>
      </div>
    </div>

    {/* Mensaje de ayuda sutil */}
    <p
      class="text-center mt-6 text-[10px] text-white/20 font-mono uppercase tracking-widest"
    >
      Redireccionando de forma segura
    </p>
  </div>
</Layout>

<style>
  @keyframes loading-bar {
    0% {
      width: 0%;
      transform: translateX(-100%);
    }
    50% {
      width: 50%;
    }
    100% {
      width: 100%;
      transform: translateX(100%);
    }
  }
  .animate-loading-bar {
    animation: loading-bar 1.5s infinite linear;
  }
</style>

<script>
  const { signIn } = await import("auth-astro/client");

  setTimeout(() => {
    signIn(
      "twitch",
      // @ts-expect-error
      { callbackUrl: "/auth/twitch/callback" },
      { ipAddress: "tururu" }
    );
  }, 800);
</script>
