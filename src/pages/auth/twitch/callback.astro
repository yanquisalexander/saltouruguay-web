---
import Layout from "@/layouts/Layout.astro";
import { sendNewLoginDetectedEmail } from "@/utils/user";
import { getSession } from "auth-astro/server";
import {
  LucideLoader2,
  LucideAlertCircle,
  LucideCheckCircle2,
} from "lucide-preact";

const ERROR_MESSAGES = {
  Configuration: "Error de configuración en el servidor. Inténtalo más tarde.",
  AccessDenied:
    "Acceso denegado. Verifica que tu cuenta de Twitch esté activa y el correo verificado.",
  Default: "Ocurrió un error inesperado durante la autenticación.",
};

const url = new URL(Astro.request.url);
const errorKey = url.searchParams.get("error");
const errorMessage =
  errorKey &&
  (ERROR_MESSAGES[errorKey as keyof typeof ERROR_MESSAGES] ||
    ERROR_MESSAGES.Default);

const session = await getSession(Astro.request);

// Enviar email si es exitoso (Server Side)
if (session && !errorMessage) {
  try {
    await sendNewLoginDetectedEmail(session.user.sessionId!, Astro.request);
  } catch (error) {
    console.error("Error sending login email:", error);
  }
}

// Determinar estado para la UI
const state = errorMessage ? "error" : session ? "success" : "loading";
---

<Layout
  hideHeader
  hideFooter
  title={state === "success" ? "¡Éxito!" : "Autenticando..."}
  description="Procesando inicio de sesión"
  mainClassname="flex flex-col items-center justify-center min-h-dvh w-full relative overflow-hidden"
>
  {/* Fondo Ambiental */}
  <div class="fixed inset-0 -z-10 bg-[#050505]">
    <div
      class="absolute inset-0 bg-[url('/images/pattern-grid.svg')] opacity-[0.03]"
    >
    </div>
    <div
      class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[500px] h-[500px] bg-purple-900/10 blur-[120px] rounded-full pointer-events-none"
    >
    </div>
  </div>

  <div class="w-full max-w-md p-4 animate-in fade-in zoom-in-95 duration-300">
    {/* TARJETA DE ESTADO */}
    <div
      class={`
          relative overflow-hidden rounded-2xl border bg-[#0a0a0a] p-8 text-center shadow-2xl
          ${state === "error" ? "border-red-500/20 shadow-red-900/10" : "border-white/10 shadow-purple-900/10"}
      `}
    >
      {/* CASO: ERROR */}
      {
        state === "error" && (
          <div class="flex flex-col items-center">
            <div class="p-4 bg-red-500/10 rounded-full text-red-500 mb-4 border border-red-500/20">
              <LucideAlertCircle size={40} />
            </div>
            <h1 class="text-xl font-anton text-white uppercase tracking-wide mb-2">
              Error de Acceso
            </h1>
            <p class="text-white/60 font-rubik text-sm mb-6">{errorMessage}</p>

            <a
              href="/auth/twitch"
              class="inline-flex items-center gap-2 px-6 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg text-sm font-bold transition-colors"
            >
              Intentar de nuevo
            </a>
          </div>
        )
      }

      {/* CASO: ÉXITO */}
      {
        state === "success" && (
          <div class="flex flex-col items-center">
            <div class="p-4 bg-green-500/10 rounded-full text-green-500 mb-4 border border-green-500/20 animate-pulse">
              <LucideCheckCircle2 size={40} />
            </div>
            <h1 class="text-xl font-anton text-white uppercase tracking-wide mb-2">
              ¡Identidad Verificada!
            </h1>
            <p class="text-white/60 font-rubik text-sm flex items-center gap-2">
              <LucideLoader2 size={14} class="animate-spin text-white/30" />{" "}
              Ingresando al sistema...
            </p>
          </div>
        )
      }

      {/* CASO: CARGANDO */}
      {
        state === "loading" && !session && (
          <div class="flex flex-col items-center">
            <div class="p-4 bg-purple-500/10 rounded-full text-purple-500 mb-4 border border-purple-500/20">
              <LucideLoader2 size={40} class="animate-spin" />
            </div>
            <h1 class="text-xl font-anton text-white uppercase tracking-wide mb-2">
              Conectando...
            </h1>
            <p class="text-white/60 font-rubik text-sm">
              Validando credenciales con Twitch
            </p>
          </div>
        )
      }
    </div>

    {/* Fallback manual */}
    {
      state === "success" && (
        <p class="text-center mt-6 text-xs text-white/20">
          ¿No te redirige?{" "}
          <a href="/" class="underline hover:text-white">
            Haz clic aquí
          </a>
        </p>
      )
    }
  </div>
</Layout>

{/* LÓGICA DE REDIRECCIÓN */}
<script is:inline define:vars={{ session: !!session, error: errorKey }}>
  setTimeout(() => {
    if (session) {
      if (window.opener) {
        window.opener.location.reload();
        window.close();
      } else {
        location.href = "/";
      }
    } else if (error) {
      if (window.opener) {
        const event = new CustomEvent("SignInError", { detail: { error } });
        window.opener.dispatchEvent(event);
        window.close();
      }
    }
  }, 1500);
</script>
