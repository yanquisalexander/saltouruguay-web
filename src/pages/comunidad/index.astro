---
import CommunityLayout from "@/layouts/CommunityLayout.astro";
import cacheService from "@/services/cache";

import { getTotalOfMemberCards } from "@/utils/user";
import { getSession } from "auth-astro/server";
import { LucideLock, LucidePencilRuler } from "lucide-preact";

const session = await getSession(Astro.request);

interface CommunityCard {
  path: string;
  requiresLogin: boolean;
  title: string;
  description: string;
  image: string;
  soon: boolean;
  soonCustomText?: string;
}

const COMMUNITY_GRID_CARDS: CommunityCard[] = [
  {
    path: "/comunidad/member-card",
    requiresLogin: true,
    title: "Miembro Saltano",
    description: "Manej치 tu perfil y particip치 en la comunidad.",
    image: "/images/member-card.webp",
    soon: false,
  },
  {
    path: "/comunidad/logros",
    requiresLogin: true,
    title: "Mis Logros",
    description: "Descubre los logros que has desbloqueado.",
    image: "/images/achievements.webp",
    soon: false,
  },
  {
    path: "/comunidad/banco",
    requiresLogin: true,
    title: "Banco Saltano",
    description: "Administra tus SaltoCoins y realiza transacciones.",
    image: "/images/banco.webp",
    soon: false,
  },
  {
    path: "/comunidad/juegos/ruleta-loca",
    requiresLogin: true,
    title: "Ruleta Loca",
    description: "Gira la ruleta, adivina letras y gana SaltoCoins.",
    image: "/images/banco.webp",
    soon: false,
  },
  /*  {
    path: "/comunidad/debate-salto-awards",
    requiresLogin: true,
    title: "Debate SaltoAwards",
    description:
      "Comparte tus opiniones sobre los SaltoAwards de forma an칩nima.",
    image: "/images/debate-salto-awards.webp",
    soon: false,
    soonCustomText: "Disponible el Jueves durante el stream",
  }, */
];

const cache = cacheService.create({ ttl: 7200 });
let totalOfMemberCards: number | null = await cache.get(
  "total-of-member-cards"
);

if (!totalOfMemberCards) {
  totalOfMemberCards = await getTotalOfMemberCards();
  await cache.set("total-of-member-cards", totalOfMemberCards);
}
---

<CommunityLayout title="Comunidad">
  <div class="flex flex-col max-w-5xl mx-auto min-h-screen mt-8">
    <header
      class="relative z-10 flex flex-col items-center justify-center h-full max-w-4xl mx-auto mb-12"
    >
      <div class="flex items-center justify-center gap-x-4">
        <div
          class="relative animate-fade-in-up"
          style="--floating-duration: 5000ms"
        >
          <img
            src="/images/logo_salto.webp"
            alt="SaltoUruguayServer"
            class="size-20 md:size-24 w-auto object-contain aspect-square animate-sink animate-iteration-count-infinite animate-duration-[var(--floating-duration)] saturate-150"
            style="image-rendering: pixelated;"
          />
        </div>
        <h1
          class="text-2xl md:text-4xl animate-fade-in-up animate-delay-150 font-press-start-2p tracking-wider uppercase text-white drop-shadow-md"
        >
          Comunidad
        </h1>
      </div>

      <h2
        class="text-xl md:text-2xl animate-fade-in-up animate-delay-300 font-vt323 uppercase text-gray-300 my-5 text-center"
      >
        춰Te damos la bienvenida a la <span class="text-yellow-400"
          >comunidad Saltana</span
        >!
      </h2>
    </header>

    {
      totalOfMemberCards ? (
        <div class="flex justify-center flex-col items-center mb-12 sm:w-max font-vt323 px-4 sm:px-8 uppercase text-lg text-white mx-auto text-center py-2 border-2 border-violet-500 bg-violet-900/50 shadow-[4px_4px_0px_0px_rgba(139,92,246,1)] hover:translate-y-1 hover:shadow-none transition-all duration-200 cursor-default">
          <p class="text-white">
            游댠
            <span class="text-yellow-400 font-bold">{totalOfMemberCards}</span>
            saltanos ya tienen su{" "}
            <span class="text-yellow-400 font-bold">Member Card</span>
            游댠
          </p>
        </div>
      ) : null
    }

    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8 p-4">
      {
        COMMUNITY_GRID_CARDS.map((card) => {
          const isDisabled = (card.requiresLogin && !session) || card.soon;
          const Tag =
            card.soon || (card.requiresLogin && !session) ? "div" : "a";
          return (
            <Tag
              href={isDisabled ? "#" : card.path}
              class={`pixel-card group relative overflow-hidden flex flex-col ${
                isDisabled ? "cursor-not-allowed opacity-75 grayscale" : ""
              }`}
              {...(!card.soon &&
                card.requiresLogin &&
                !session && { "data-click-to-login": true })}
              aria-disabled={isDisabled}
              title={
                card.soon
                  ? card.soonCustomText || "Pr칩ximamente"
                  : card.requiresLogin && !session
                    ? "Inicia sesi칩n para acceder"
                    : ""
              }
            >
              <div class="relative h-48 overflow-hidden border-b-4 border-black">
                <img
                  src={card.image}
                  alt={card.title}
                  class="w-full h-full object-cover object-center group-hover:scale-110 transition-transform duration-500"
                  style="image-rendering: pixelated;"
                />
                {isDisabled && (
                  <div class="absolute inset-0 bg-black/60 flex items-center justify-center">
                    <LucideLock className="text-white w-12 h-12" />
                  </div>
                )}
              </div>

              <div class="p-6 flex-1 flex flex-col bg-[#1f2937]">
                <h3 class="text-sm md:text-base font-press-start-2p uppercase text-white mb-4 leading-relaxed group-hover:text-yellow-400 transition-colors">
                  {card.title}
                </h3>
                <p class="text-lg text-gray-400 font-vt323 leading-tight">
                  {card.description}
                </p>

                {card.soon && (
                  <div class="mt-4 inline-block bg-red-600 text-white text-xs font-press-start-2p px-2 py-1 self-start">
                    SOON
                  </div>
                )}
              </div>
            </Tag>
          );
        })
      }
    </div>
  </div>
</CommunityLayout>

<script>
  import { showSignInDialog } from "@/lib/utils";

  const handlePageLoad = async () => {
    const cards = document.querySelectorAll("[data-click-to-login]");
    cards.forEach((card) => {
      card.addEventListener("click", (event) => {
        if (card.getAttribute("aria-disabled") === "true") {
          event.preventDefault();
          showSignInDialog();
        }
      });
    });
  };

  document.addEventListener("astro:page-load", handlePageLoad);

  document.addEventListener("astro:before-swap", () => {
    document.removeEventListener("astro:page-load", handlePageLoad);
  });
</script>

<script data-astro-rerun>
  (async () => {
    try {
      await new Promise((resolve) => setTimeout(resolve, 1000));
      await fetch("/api/cinematics?name=community");
    } catch (error) {}
  })();
</script>
