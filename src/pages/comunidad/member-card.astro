---
import { MyMemberCard } from "@/components/MyMemberCard";
import type { MemberCardSkins } from "@/consts/MemberCardSkins";
import CommunityLayout from "@/layouts/CommunityLayout.astro";
import { getMemberCardData } from "@/utils/user";
import { getSession } from "auth-astro/server";
import { LucideSparkles, LucidePalette } from "lucide-preact";

const session = await getSession(Astro.request);

if (!session) {
  return Astro.redirect("/");
}

const dbMemberCard = await getMemberCardData(parseInt(session.user.id));
const stickers: string[] = dbMemberCard?.stickers ?? [];
const initialSkin =
  dbMemberCard?.skin as (typeof MemberCardSkins)[number]["id"];
---

<CommunityLayout
  title="Member Card Studio"
  description="Personaliza tu tarjeta de identidad de la comunidad"
>
  <div class="flex flex-col items-center w-full min-h-full">
    {/* HEADER DE SECCIÓN */}
    <header
      class="w-full max-w-4xl mx-auto text-center pt-8 pb-4 px-4 space-y-4"
    >
      {/* Badge */}
      <div
        class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-purple-500/10 border border-purple-500/20 backdrop-blur-md animate-fade-in-down"
      >
        <LucidePalette size={14} class="text-purple-400" />
        <span
          class="text-xs font-bold text-purple-300 uppercase tracking-wider"
        >
          Personaliza tu tarjeta
        </span>
      </div>

      {/* Título Principal */}
      <h1
        class="text-4xl md:text-6xl font-anton text-white uppercase tracking-tight"
      >
        Tu Identidad <span
          class="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500"
          >Digital</span
        >
      </h1>

      {/* Subtítulo / Bienvenida */}
      <p
        class="text-white/60 font-rubik text-sm md:text-base max-w-lg mx-auto leading-relaxed"
      >
        Hola <span class="text-white font-bold">{session.user.name}</span>, este
        es tu espacio creativo. Elige tu skin, gestiona tus stickers y descarga
        tu tarjeta oficial.
      </p>
    </header>

    {/* SEPARADOR VISUAL */}
    <div
      class="w-full max-w-xs h-px bg-gradient-to-r from-transparent via-white/10 to-transparent my-6"
    >
    </div>

    {/* COMPONENTE PRINCIPAL (EDITOR) */}
    <section class="w-full flex-1">
      <MyMemberCard
        session={session}
        stickers={stickers}
        initialSkin={initialSkin}
        tier={session.user.tier ?? null}
        client:only="preact"
      />
    </section>
  </div>
</CommunityLayout>
