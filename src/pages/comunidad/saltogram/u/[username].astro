---
import Layout from "@/layouts/Layout.astro";
import { getSession } from "auth-astro/server";
import SaltogramFeed from "@/components/saltogram/SaltogramFeed";
import FriendButton from "@/components/saltogram/FriendButton";
import { client } from "@/db/client";
import { UsersTable, FriendsTable } from "@/db/schema";
import { eq, and, or, count } from "drizzle-orm";
import {
  LucideMapPin,
  LucideCalendar,
  LucideLink,
  LucideBadgeCheck,
  LucideCrown,
} from "lucide-preact";
import { format } from "date-fns";
import { es } from "date-fns/locale";

const { username } = Astro.params;
const session = await getSession(Astro.request);
const currentUserId = session?.user?.id ? Number(session.user.id) : null;

if (!username) {
  return Astro.redirect("/404");
}

const user = await client.query.UsersTable.findFirst({
  where: eq(UsersTable.username, username),
  columns: {
    id: true,
    username: true,
    displayName: true,
    avatar: true,
    createdAt: true,
    admin: true,
    twitchTier: true,
  },
});

if (!user) {
  return Astro.redirect("/404");
}

// Get friend status
let friendStatus: "none" | "pending_sent" | "pending_received" | "accepted" =
  "none";
let requestId: number | undefined;

if (currentUserId && currentUserId !== user.id) {
  const friendship = await client.query.FriendsTable.findFirst({
    where: or(
      and(
        eq(FriendsTable.userId, currentUserId),
        eq(FriendsTable.friendId, user.id)
      ),
      and(
        eq(FriendsTable.userId, user.id),
        eq(FriendsTable.friendId, currentUserId)
      )
    ),
  });

  if (friendship) {
    requestId = friendship.id;
    if (friendship.status === "accepted") {
      friendStatus = "accepted";
    } else if (friendship.status === "pending") {
      friendStatus =
        friendship.userId === currentUserId
          ? "pending_sent"
          : "pending_received";
    }
  }
}

// Get friends count
const [friendsCountResult] = await client
  .select({ count: count() })
  .from(FriendsTable)
  .where(
    and(
      or(eq(FriendsTable.userId, user.id), eq(FriendsTable.friendId, user.id)),
      eq(FriendsTable.status, "accepted")
    )
  );

const friendsCount = friendsCountResult?.count ?? 0;

// Get some friends for display
const friends = await client.query.FriendsTable.findMany({
  where: and(
    or(eq(FriendsTable.userId, user.id), eq(FriendsTable.friendId, user.id)),
    eq(FriendsTable.status, "accepted")
  ),
  limit: 9,
  with: {
    user: true,
    friend: true,
  },
});

const friendUsers = friends.map((f) =>
  f.userId === user.id ? f.friend : f.user
);
---

<Layout title={`${user.displayName} (@${user.username}) - Saltogram`}>
  <div class="fixed inset-0 -z-10 bg-[#050505]">
    <div
      class="absolute inset-0 bg-[url('/images/pattern-grid.svg')] opacity-5"
    >
    </div>
  </div>

  <div class="max-w-7xl mx-auto min-h-screen sm:px-6 pt-24 pb-20">
    {/* Profile Header */}
    <div class="relative mb-8">
      {/* Cover Photo Placeholder */}
      <div
        class="h-64 w-full bg-gradient-to-r from-purple-900 to-blue-900 rounded-b-3xl relative overflow-hidden"
      >
        <div class="absolute inset-0 bg-black/20"></div>
      </div>

      <div class="px-8 pb-6">
        <div class="relative -mt-20 flex flex-col md:flex-row items-end gap-6">
          {/* Avatar */}
          <div class="relative">
            <div
              class="w-40 h-40 rounded-full border-4 border-[#050505] bg-[#1a1a1a] overflow-hidden shadow-2xl"
            >
              <img
                src={user.avatar ||
                  `https://ui-avatars.com/api/?name=${user.displayName}&background=random`}
                alt={user.displayName}
                class="w-full h-full object-cover"
              />
            </div>
          </div>

          {/* Info */}
          <div class="flex-1 mb-2">
            <div class="flex items-center gap-2 flex-wrap">
              <h1 class="text-3xl font-bold text-white">{user.displayName}</h1>
              {
                user.admin && (
                  <LucideBadgeCheck
                    class="text-blue-400 fill-blue-400/10"
                    size={28}
                  />
                )
              }
              {
                user.twitchTier && user.twitchTier > 0 && (
                  <span class="bg-purple-500/20 text-purple-400 text-xs px-2 py-1 rounded-full border border-purple-500/30 flex items-center gap-1">
                    <LucideCrown size={14} />
                    <span class="font-bold">TIER {user.twitchTier}</span>
                  </span>
                )
              }
            </div>
            <p class="text-white/60 font-medium">@{user.username}</p>

            <div class="flex items-center gap-4 mt-4 text-sm text-white/40">
              <div class="flex items-center gap-1">
                <LucideCalendar size={14} />
                <span>
                  Se unió el {
                    format(new Date(user.createdAt), "PPP", { locale: es })
                  }
                </span>
              </div>
              <div class="flex items-center gap-1">
                <span>{friendsCount} amigos</span>
              </div>
            </div>
          </div>

          {/* Actions */}
          <div class="mb-4 flex gap-3">
            {
              currentUserId && currentUserId !== user.id && (
                <FriendButton
                  client:load
                  friendId={user.id}
                  initialStatus={friendStatus}
                  requestId={requestId}
                />
              )
            }
            {
              currentUserId === user.id && (
                <a
                  href="/settings"
                  class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors"
                >
                  Editar perfil
                </a>
              )
            }
          </div>
        </div>
      </div>
    </div>

    {/* Content Grid */}
    <div class="grid grid-cols-1 lg:grid-cols-[300px_1fr] gap-8 px-4 sm:px-0">
      {/* Sidebar Info */}
      <aside class="space-y-6">
        <div
          class="bg-[#0a0a0a]/60 backdrop-blur-xl border border-white/10 rounded-2xl p-6"
        >
          <h3 class="text-lg font-bold text-white mb-4">Detalles</h3>
          <div class="space-y-4 text-sm text-white/60">
            <p>Miembro de la comunidad Salto Uruguay.</p>
          </div>
        </div>

        {/* Friends Grid */}
        <div
          class="bg-[#0a0a0a]/60 backdrop-blur-xl border border-white/10 rounded-2xl p-6"
        >
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-white">Amigos</h3>
            <span class="text-xs text-white/40">{friendsCount}</span>
          </div>

          {
            friendUsers.length > 0 ? (
              <div class="grid grid-cols-3 gap-3">
                {friendUsers.map((friend) => (
                  <a
                    href={`/comunidad/saltogram/u/${friend.username}`}
                    class="group"
                  >
                    <div class="aspect-square rounded-lg overflow-hidden mb-1 border border-white/10 group-hover:border-white/30 transition-colors">
                      <img
                        src={
                          friend.avatar ||
                          `https://ui-avatars.com/api/?name=${friend.displayName}`
                        }
                        alt={friend.displayName}
                        class="w-full h-full object-cover"
                      />
                    </div>
                    <p class="text-[10px] font-medium text-white truncate group-hover:underline">
                      {friend.displayName}
                    </p>
                  </a>
                ))}
              </div>
            ) : (
              <p class="text-sm text-white/40">No hay amigos aún.</p>
            )
          }
        </div>
      </aside>

      {/* Feed */}
      <main>
        <SaltogramFeed
          client:load
          user={session?.user}
          targetUserId={user.id}
        />
      </main>
    </div>
  </div>
</Layout>
