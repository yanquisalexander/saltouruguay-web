---
import Layout from "@/layouts/Layout.astro";
import { getSession } from "auth-astro/server";
import SaltogramFeed from "@/components/saltogram/SaltogramFeed";
import FriendRequestsWidget from "@/components/saltogram/FriendRequestsWidget";
import SuggestedUsersWidget from "@/components/saltogram/SuggestedUsersWidget";
import StoriesRail from "@/components/saltogram/stories/StoriesRail";
import {
  LucideCamera,
  LucideTrendingUp,
  LucideSend,
  LucideGamepad2,
  LucideMic,
  LucideCalendar,
} from "lucide-preact";
import { getSaltogramStats, getTrendingTags } from "@/lib/saltogram";
import { client } from "@/db/client";
import { FriendsTable, UsersTable } from "@/db/schema";
import { eq, and, notInArray, sql } from "drizzle-orm";

const session = await getSession(Astro.request);

const stats = await getSaltogramStats();
const trendingTags = await getTrendingTags();

const friendRequests = session?.user?.id
  ? await client
      .select({
        id: FriendsTable.id,
        createdAt: FriendsTable.createdAt,
        user: {
          id: UsersTable.id,
          displayName: UsersTable.displayName,
          username: UsersTable.username,
          avatar: UsersTable.avatar,
        },
      })
      .from(FriendsTable)
      .innerJoin(UsersTable, eq(FriendsTable.userId, UsersTable.id))
      .where(
        and(
          eq(FriendsTable.friendId, Number(session.user.id)),
          eq(FriendsTable.status, "pending")
        )
      )
      .limit(3)
  : [];

// Fetch Suggested Users (Not friends, not self)
let suggestedUsers: any[] = [];
if (session?.user?.id) {
  const currentUserId = Number(session.user.id);

  // Get IDs to exclude (self + friends + pending)
  const friends1 = await client
    .select({ id: FriendsTable.friendId })
    .from(FriendsTable)
    .where(eq(FriendsTable.userId, currentUserId));
  const friends2 = await client
    .select({ id: FriendsTable.userId })
    .from(FriendsTable)
    .where(eq(FriendsTable.friendId, currentUserId));

  const excludeIds = [
    currentUserId,
    ...friends1.map((f) => f.id),
    ...friends2.map((f) => f.id),
  ];

  suggestedUsers = await client
    .select({
      id: UsersTable.id,
      displayName: UsersTable.displayName,
      username: UsersTable.username,
      avatar: UsersTable.avatar,
    })
    .from(UsersTable)
    .where(notInArray(UsersTable.id, excludeIds))
    .limit(3)
    .orderBy(sql`RANDOM()`);
}
---

<Layout title="Saltogram - Social">
  {/* Fondo Ambiental */}
  <div class="fixed inset-0 -z-10 bg-[#050505]">
    <div
      class="absolute inset-0 bg-[url('/images/pattern-grid.svg')] opacity-5"
    >
    </div>
    <div
      class="absolute top-0 left-1/2 -translate-x-1/2 w-full max-w-4xl h-[600px] bg-purple-900/10 blur-[150px] rounded-full pointer-events-none"
    >
    </div>
  </div>

  <div class="flex flex-col max-w-7xl mx-auto min-h-screen sm:px-6 pt-24 pb-20">
    {/* HEADER COMPACTO */}
    <header
      class="flex flex-col md:flex-row items-center justify-between gap-6 mb-8 pb-6 border-b border-white/5"
    >
      <div class="flex items-center gap-4">
        <div
          class="p-3 bg-gradient-to-br from-pink-500 to-purple-600 rounded-2xl shadow-lg shadow-purple-500/20 text-white"
        >
          <LucideCamera size={32} />
        </div>
        <div>
          <h1 class="text-4xl font-anton text-white uppercase tracking-wide">
            Saltogram
          </h1>
          <p class="text-white/50 font-rubik text-sm">
            Tu ventana a la comunidad
          </p>
        </div>
      </div>

      <div class="flex gap-4 items-center">
        {/* Mensajes Directos */}
        <a
          href="/comunidad/saltogram/direct"
          class="flex items-center justify-center w-12 h-12 rounded-xl bg-white/5 border border-white/10 text-white hover:bg-white/10 hover:scale-105 transition-all relative group"
          title="Mensajes Directos"
        >
          <LucideSend size={20} />
        </a>

        {/* Stats Rápidos (Ejemplo Visual) */}
        <div
          class="hidden md:flex items-center gap-6 px-6 py-3 rounded-xl bg-white/5 border border-white/5 backdrop-blur-sm"
        >
          <div class="text-center">
            <span class="block text-lg font-bold text-white leading-none"
              >{stats.posts}</span
            >
            <span class="text-[10px] text-white/40 uppercase tracking-widest"
              >Posts</span
            >
          </div>
          <div class="w-px h-8 bg-white/10"></div>
          <div class="text-center">
            <span class="block text-lg font-bold text-white leading-none"
              >{stats.likes}</span
            >
            <span class="text-[10px] text-white/40 uppercase tracking-widest"
              >Likes</span
            >
          </div>
        </div>
      </div>
    </header>

    {/* FEED LAYOUT (2 Columnas en Desktop) */}
    <div class="grid grid-cols-1 lg:grid-cols-[1fr_300px] gap-8">
      {/* Main Feed */}
      <main>
        <StoriesRail client:load user={session?.user} />
        <SaltogramFeed client:load user={session?.user} />
      </main>

      {/* Sidebar (Tendencias / Sugerencias) */}
      <aside class="hidden lg:block space-y-6">
        {/* Friend Requests */}
        {
          friendRequests.length > 0 && (
            <FriendRequestsWidget
              client:load
              initialRequests={friendRequests}
            />
          )
        }

        {/* User Profile Link */}
        {
          session?.user && (
            <div class="bg-[#0a0a0a]/60 backdrop-blur-xl border border-white/10 rounded-2xl p-6">
              <div class="flex items-center gap-4 mb-4">
                <img
                  src={
                    session.user.image ||
                    `https://ui-avatars.com/api/?name=${session.user.name}`
                  }
                  alt={session.user.name}
                  class="w-12 h-12 rounded-full border border-white/10"
                />
                <div>
                  <h3 class="font-bold text-white">{session.user.name}</h3>
                  <a
                    href={`/comunidad/saltogram/u/${session.user.username}`}
                    class="text-xs text-purple-400 hover:text-purple-300"
                  >
                    Ver mi perfil
                  </a>
                </div>
              </div>
            </div>
          )
        }

        {/* Suggested Users */}
        {
          suggestedUsers.length > 0 && (
            <SuggestedUsersWidget client:idle users={suggestedUsers} />
          )
        }

        {/* Quick Links */}
        <div
          class="bg-[#0a0a0a]/60 backdrop-blur-xl border border-white/10 rounded-2xl p-6"
        >
          <h3
            class="text-lg font-anton text-white uppercase tracking-wide mb-4"
          >
            Explorar
          </h3>
          <div class="space-y-2">
            <a
              href="/eventos"
              class="flex items-center gap-3 p-3 rounded-xl bg-white/5 hover:bg-white/10 transition-colors group"
            >
              <div
                class="p-2 bg-yellow-500/20 text-yellow-400 rounded-lg group-hover:scale-110 transition-transform"
              >
                <LucideCalendar size={20} />
              </div>
              <div>
                <p class="text-sm font-bold text-white">Eventos</p>
                <p class="text-xs text-white/40">Próximas actividades</p>
              </div>
            </a>
          </div>
        </div>

        {/* Tendencias */}
        <div
          class="bg-[#0a0a0a]/60 backdrop-blur-xl border border-white/10 rounded-2xl p-6 sticky top-28"
        >
          <h3
            class="text-lg font-anton text-white uppercase tracking-wide mb-4 flex items-center gap-2"
          >
            <LucideTrendingUp size={18} class="text-yellow-500" /> Tendencias
          </h3>

          <div class="space-y-4">
            {
              trendingTags.length > 0 ? (
                trendingTags.map((tag) => (
                  <a
                    href={`/comunidad/saltogram?tag=${tag.tag.replace("#", "")}`}
                    class="flex items-center justify-between group cursor-pointer"
                  >
                    <div>
                      <p class="text-sm font-bold text-white group-hover:text-purple-400 transition-colors">
                        {tag.tag}
                      </p>
                      <p class="text-xs text-white/30">
                        {tag.count} posts recientes
                      </p>
                    </div>
                    <div class="opacity-0 group-hover:opacity-100 transition-opacity text-white/50 text-xs">
                      Ver
                    </div>
                  </a>
                ))
              ) : (
                <p class="text-white/30 text-sm">No hay tendencias aún.</p>
              )
            }
          </div>
        </div>
      </aside>
    </div>
  </div>
</Layout>
