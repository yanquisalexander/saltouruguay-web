---
import Layout from "@/layouts/Layout.astro";

/* ðŸ”¹ Fallback si todavÃ­a no hay datos guardados */
const fallbackGroups = {
  A: [
    "anti-therian",
    "que-pelota-gerson",
    "desertores-cubicos",
    "fuerza-torales",
  ],
  B: ["la-141", "los-changos", "los-sin-pelo", "mate-&-taco"],
  C: ["puskas", "ss", "team-fzbr", "therian-&-furious"],
  D: ["toxicos-a-la-pala", "vasacorrer", "x-force", "yen"],
};
---

<Layout title="Sorteo Oficial" mainClassname="px-6 sm:px-10 pt-24 pb-32">
  <section class="max-w-7xl mx-auto">
    <!-- TÃTULO -->
    <div class="text-center mb-12">
      <p
        class="uppercase tracking-[0.1em] text-4xl md:text-6xl font-anton font-bold mb-2 text-white drop-shadow-lg"
      >
        TORNEO ROCKET LEAGUE
      </p>

      <h1
        class="font-anton text-4xl md:text-5xl mt-2 bg-gradient-to-r from-amber-400 to-yellow-300 bg-clip-text text-transparent"
      >
        Sorteo Oficial
      </h1>
    </div>

    <!-- GRUPOS -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
      {
        Object.entries(fallbackGroups).map(([group, teams]) => (
          <div class="rounded-2xl border border-white/10 bg-white/5 p-8 shadow-lg">
            <h2 class="text-center font-bold text-2xl md:text-3xl text-amber-300 mb-6">
              Grupo {group}
            </h2>

            <ul id={`group-${group}`} class="grid grid-cols-1 gap-3">
              {teams.map((team) => (
                <li class="flex items-center gap-3 bg-white/5 border border-white/10 rounded-lg px-3 py-2 w-full h-16">
                  <img
                    src={`/images/team-logos/${team}.webp`}
                    alt={team}
                    class="w-10 h-10 object-contain"
                  />
                  <span class="font-semibold text-lg truncate">{team}</span>
                </li>
              ))}
            </ul>
          </div>
        ))
      }
    </div>
  </section>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // track last data so we can avoid rewrites when nothing changed
      let currentData: Record<string, string[]> | null = null;

      const render = (data: Record<string, string[]>) => {
        Object.entries(data).forEach(([group, teams]: [string, string[]]) => {
          const container = document.getElementById(`group-${group}`);
          if (!container) return;

          container.innerHTML = "";
          teams.forEach((team: string) => {
            const li = document.createElement("li");
            li.className =
              "flex items-center gap-3 bg-white/5 border border-white/10 rounded-lg px-3 py-2";

            li.innerHTML = `
          <img src="/images/team-logos/${team}.webp" class="w-10 h-10 object-contain" />
          <span class="font-semibold text-lg">${team}</span>
        `;

            container.appendChild(li);
          });
        });
      };

      const fetchAndMaybeRender = async () => {
        try {
          const resp = await fetch("/api/draw-results");
          if (!resp.ok) return;
          const data = await resp.json();
          if (data && typeof data === "object") {
            const str = JSON.stringify(data);
            if (str !== JSON.stringify(currentData)) {
              currentData = data;
              render(data);
            }
          }
        } catch (e) {
          console.warn("No se pudo cargar resultados desde el servidor", e);
        }
      };

      // initial load (will not replace fallback if server returns empty object)
      fetchAndMaybeRender();
      // poll every 10 seconds
      setInterval(fetchAndMaybeRender, 10000);
    });
  </script>
</Layout>
