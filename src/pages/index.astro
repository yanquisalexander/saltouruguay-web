---
import LaunchCountdown from "@/components/LaunchCountdown";
import Layout from "../layouts/Layout.astro";
import { EVENT_TIMESTAMP, IS_VOTES_OPEN, VOTES_OPEN_TIMESTAMP } from "@/config";
import Sponsors from "@/sections/Sponsors.astro";
import LiveStream from "@/components/LiveStream.astro";
import VoteCallToAction from "@/components/VoteCallToAction.astro";
import NewsOnPage from "@/sections/NewsOnPage.astro";
import UpcomingCompetitions from "@/sections/UpcomingCompetitions.astro";
import { FeaturedNews } from "@/components/FeaturedNews";
import Advantages from "@/sections/Advantages.astro";
import StreamerWars from "@/sections/StreamerWars.astro";
import CountdownSaltoCraft from "@/sections/CountdownSaltoCraft.astro";
import Required2FA from "@/components/admin/Required2FA.astro";
import StingerGsap from "@/components/StingerGsap";

const IS_PROD = import.meta.env.PROD;

const SHOW_AWARDS_COUNTDOWN = false;

export const prerender = true;
---

<Layout
  title="Comunidad SaltoUruguayServer"
  description="Te damos la bienvenida a la comunidad del canal de SaltoUruguayServer en Twitch. ¡Los #SaltoAwards2025 será un evento inolvidable!"
>
  <!-- Hero fijo en viewport -->
  <section
    id="hero"
    class="fixed inset-0 flex items-center justify-center z-0 bg-transparent"
  >
    <div
      class="hero-inner w-full max-w-6xl px-6 text-center pointer-events-none"
    >
      <div class="hero-fade pointer-events-auto pb-4">
        <Required2FA server:defer />
        <!-- <VoteCallToAction server:defer /> -->
      </div>
      <header
        class="flex items-center justify-center w-full gap-x-14 gap-y-6 flex-col md:flex-row pointer-events-auto"
      >
        <div class="relative">
          <img
            src="/favicon.svg"
            alt="SaltoUruguayServer"
            draggable="false"
            class="hero-logo h-24 sm:h-28 w-auto object-contain aspect-square"
          />
          <img
            src="/favicon.svg"
            alt="SaltoUruguayServer"
            draggable="false"
            class="hero-logo-glow absolute transform scale-110 saturate-150 z-[-1] top-0 left-0 h-24 sm:h-28 w-auto object-contain aspect-square"
          />
        </div>
        <h1
          class="hero-title text-3xl md:text-4xl lg:text-5xl xl:text-6xl font-anton text-balance flex-wrap"
        >
          SALTO URUGUAY SERVER
        </h1>
      </header>
    </div>
  </section>

  <!-- Spacer para mantener el flujo del documento -->
  <div class="hero-spacer h-screen w-full" aria-hidden="true"></div>

  <!-- Contenido principal: estará por encima del hero al hacer scroll -->
  <div class="page-content relative z-10">
    <StingerGsap client:only transition:persist="stinger-su" />

    <LiveStream server:defer />

    <FeaturedNews client:idle />

    <Advantages />

    <!--   <UpcomingCompetitions server:defer />
 -->
    <NewsOnPage />

    <Sponsors />
  </div>
</Layout>

<style>
  /* Hero fixed y animaciones scroll-driven */
  #hero {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 0;
    pointer-events: none;

    /* variable para controlar el blur máximo del logo */
    --hero-logo-blur: 6px;

    /* variables para retrasar el inicio y controlar el rango de la animación (puedes ajustar) */
    --hero-anim-start: 30vh; /* empieza cuando se ha scrolleado 12vh */
    --hero-anim-end: 60vh; /* termina en 60vh */

    animation-timeline: scroll();
    animation-range: 0 100vh;
  }

  .hero-inner {
    pointer-events: auto;
  }

  /* Logo: escala y se desplaza ligeramente hacia arriba al hacer scroll */
  .hero-logo {
    transition:
      transform 320ms cubic-bezier(0.22, 0.9, 0.28, 1),
      filter 320ms cubic-bezier(0.22, 0.9, 0.28, 1);
    transform-origin: center;
    animation: logo-scale 1.4s cubic-bezier(0.22, 0.9, 0.28, 1) both;
    animation-timeline: scroll();
    animation-range: var(--hero-anim-start) var(--hero-anim-end);
    will-change: transform, filter;
    filter: blur(0px);
  }

  .hero-logo-glow {
    transition:
      opacity 360ms ease,
      filter 360ms ease,
      transform 360ms ease;
    animation: glow-fade 1.4s cubic-bezier(0.22, 0.9, 0.28, 1) both;
    animation-timeline: scroll();
    animation-range: var(--hero-anim-start) var(--hero-anim-end);
    will-change: opacity, filter, transform;
  }

  .hero-title {
    transition:
      opacity 360ms cubic-bezier(0.22, 0.9, 0.28, 1),
      transform 360ms cubic-bezier(0.22, 0.9, 0.28, 1),
      filter 360ms cubic-bezier(0.22, 0.9, 0.28, 1);
    animation: title-fade 1.4s cubic-bezier(0.22, 0.9, 0.28, 1) both;
    animation-timeline: scroll();
    animation-range: var(--hero-anim-start) var(--hero-anim-end);
    will-change: opacity, transform, filter;
  }

  @keyframes logo-scale {
    0% {
      transform: translateY(0) scale(1);
      filter: blur(0px);
    }
    100% {
      transform: translateY(-8%) scale(1.6);
      filter: blur(var(--hero-logo-blur));
    }
  }

  @keyframes glow-fade {
    0% {
      opacity: 1;
      filter: blur(6px);
      transform: scale(1.08);
    }
    100% {
      opacity: 0;
      filter: blur(12px);
      transform: scale(1.12);
    }
  }

  @keyframes title-fade {
    0% {
      opacity: 1;
      transform: translateY(0);
      filter: blur(0px);
    }
    100% {
      opacity: 0;
      transform: translateY(-10%);
      filter: blur(4px);
    }
  }

  .page-content {
    position: relative;
    z-index: 10;
  }

  /* Animación scroll-driven para cualquier contenido dentro del hero que quieras que se desvanezca */
  .hero-fade {
    animation: content-fade 1.4s cubic-bezier(0.22, 0.9, 0.28, 1) both;
    animation-timeline: scroll();
    animation-range: 0 60vh;
    will-change: opacity, filter, transform;
  }

  @keyframes content-fade {
    0% {
      opacity: 1;
      transform: translateY(0);
      filter: blur(0px);
    }
    100% {
      opacity: 0;
      transform: translateY(-6%);
      filter: blur(4px);
    }
  }

  @media (max-width: 767px) {
    /* ajustar el rango del hero en móvil para que empiece ligeramente antes/termine antes */
    #hero {
      --hero-anim-start: 8vh;
      --hero-anim-end: 40vh;
    }
    .hero-logo {
      animation-range: var(--hero-anim-start) var(--hero-anim-end);
    }
    .hero-logo-glow {
      animation-range: var(--hero-anim-start) var(--hero-anim-end);
    }
    .hero-title {
      animation-range: var(--hero-anim-start) var(--hero-anim-end);
    }
  }
</style>

<script>
  import { $ } from "@/lib/dom-selector";

  document.addEventListener("astro:page-load", () => {
    const hero = $("#hero");
    const logo = $(".hero-logo") as HTMLElement;
    const glow = $(".hero-logo-glow");
    const title = $(".hero-title");
    const heroFadeEls = Array.from(
      document.querySelectorAll(".hero-fade")
    ) as HTMLElement[];
    if (!hero) return;

    const supportsScrollTimeline =
      CSS &&
      CSS.supports &&
      (CSS.supports("animation-timeline: scroll()") ||
        CSS.supports("--fake-var: 0"));
    if (supportsScrollTimeline) return;

    // leer la variable CSS --hero-logo-blur para usarla en el fallback
    const computeMaxLogoBlur = () => {
      const el = hero || document.documentElement;
      const val =
        getComputedStyle(el).getPropertyValue("--hero-logo-blur") ||
        getComputedStyle(document.documentElement).getPropertyValue(
          "--hero-logo-blur"
        );
      const parsed = parseFloat(val);
      return Number.isFinite(parsed) ? parsed : 3; // px
    };

    const maxLogoBlur = computeMaxLogoBlur();

    // leer rango de animación definido por variables CSS y convertir unidades vh/px a px
    const parseRangeValue = (raw: string) => {
      if (!raw) return null;
      raw = raw.trim();
      if (raw.endsWith("vh")) {
        const n = parseFloat(raw.replace("vh", "")) || 0;
        return (n / 100) * window.innerHeight;
      }
      if (raw.endsWith("px")) {
        return parseFloat(raw.replace("px", "")) || 0;
      }
      // fallback: try parseFloat
      const v = parseFloat(raw);
      return Number.isFinite(v) ? v : null;
    };

    const computeAnimRange = () => {
      const el = hero || document.documentElement;
      const rawStart =
        getComputedStyle(el).getPropertyValue("--hero-anim-start") ||
        getComputedStyle(document.documentElement).getPropertyValue(
          "--hero-anim-start"
        );
      const rawEnd =
        getComputedStyle(el).getPropertyValue("--hero-anim-end") ||
        getComputedStyle(document.documentElement).getPropertyValue(
          "--hero-anim-end"
        );
      const startPx = parseRangeValue(rawStart) ?? 0;
      const endPx = parseRangeValue(rawEnd) ?? window.innerHeight * 0.6;
      return { startPx, endPx };
    };

    let { startPx, endPx } = computeAnimRange();
    // recompute on resize
    window.addEventListener("resize", () => {
      const r = computeAnimRange();
      startPx = r.startPx;
      endPx = r.endPx;
    });

    // rAF-based smooth scroll handler
    let latestScroll = 0;
    let ticking = false;

    const applyScrollEffects = (scrolled: number) => {
      // map scrolled (px) into [0,1] according to anim range, then ease
      const scrolledPx = scrolled * window.innerHeight;
      const tRaw = (scrolledPx - startPx) / Math.max(1, endPx - startPx);
      const t = Math.min(1, Math.max(0, tRaw));
      // easing para suavizar el valor (easeOutCubic)
      const eased = 1 - Math.pow(1 - t, 3);

      // logo scale up to 1.6
      const logoScale = 1 + eased * 0.6;
      const logoTranslate = -eased * 8; // percent
      if (logo) {
        logo.style.transform = `translateY(${logoTranslate}%) scale(${logoScale})`;
        logo.style.filter = `blur(${Math.min(maxLogoBlur, eased * maxLogoBlur)}px)`;
      }

      // glow fades out
      if (glow) {
        glow.style.opacity = String(Math.max(0, 1 - eased * 1.3));
        glow.style.filter = `blur(${Math.min(12, eased * 12)}px)`;
        glow.style.transform = `scale(${1.08 + eased * 0.04})`;
      }

      // title fades and blurs
      if (title) {
        title.style.opacity = String(Math.max(0, 1 - eased * 1.2));
        title.style.transform = `translateY(${-eased * 10}%)`;
        title.style.filter = `blur(${Math.min(4, eased * 4)}px)`;
      }

      // Animate any hero-fade elements (e.g. VoteCallToAction)
      if (heroFadeEls && heroFadeEls.length) {
        const contentBlurMax = 4; // px
        heroFadeEls.forEach((el) => {
          el.style.opacity = String(Math.max(0, 1 - eased * 1.15));
          el.style.filter = `blur(${Math.min(contentBlurMax, eased * contentBlurMax)}px)`;
          el.style.transform = `translateY(${-eased * 6}%)`;
        });
      }

      // overall hero subtle opacity
      if (hero) hero.style.opacity = String(1 - eased * 0.12);
    };

    const onScroll = () => {
      latestScroll = Math.min(window.scrollY / window.innerHeight, 1);
      if (!ticking) {
        ticking = true;
        requestAnimationFrame(() => {
          applyScrollEffects(latestScroll);
          ticking = false;
        });
      }
    };

    window.addEventListener("scroll", onScroll, { passive: true });
    // inicializar una vez
    onScroll();
  });
</script>
