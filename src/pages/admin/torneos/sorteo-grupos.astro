---
import Layout from "@/layouts/Layout.astro";
---

<Layout title="Sorteo de Grupos" mainClassname="px-6 sm:px-10 pt-24 pb-32">
  <section class="max-w-6xl mx-auto">

    <!-- T√çTULO -->
    <div class="text-center mb-8">
      <p class="uppercase tracking-[0.1em] text-4xl md:text-6xl font-anton font-bold mb-2 text-white drop-shadow-lg">
        TORNEO ROCKET LEAGUE
      </p>

      <h1 class="font-anton text-4xl md:text-5xl mt-2 bg-gradient-to-r from-amber-400 to-yellow-300 bg-clip-text text-transparent">
        Sorteo de Grupos
      </h1>
    </div>

    <!-- GRILLA PREVIEW -->
    <div class="mb-8 grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
      <div class="lg:col-span-3 flex justify-center">
        <div id="teamGridPreview" class="grid grid-cols-4 gap-2"></div>
      </div>
    </div>

    <!-- CONTROLES -->
    <div class="flex flex-wrap gap-3 mb-8">
      <select id="groupSelect" class="bg-white/5 border border-white/10 rounded-lg px-4 py-2">
        <option value="A">Grupo A</option>
        <option value="B">Grupo B</option>
        <option value="C">Grupo C</option>
        <option value="D">Grupo D</option>
      </select>

      <button onclick="drawTeam()" class="px-5 py-2 rounded-lg font-semibold bg-gradient-to-r from-amber-400 to-yellow-300 text-black hover:scale-105 transition">
        üé≤ Sortear equipo
      </button>

      <button onclick="undoLastDraw()" class="px-5 py-2 rounded-lg font-semibold bg-white/10 hover:bg-white/20 transition">
        ‚Ü©Ô∏è Undo
      </button>

      <button onclick="resetDraw()" class="px-5 py-2 rounded-lg font-semibold bg-white/10 hover:bg-white/20 transition">
        üîÑ Reiniciar
      </button>
    </div>

    <div id="result" class="text-center text-lg font-semibold text-green-400 mb-6"></div>

    <!-- GRUPOS -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5">
      {["A","B","C","D"].map(group => (
        <div class="rounded-2xl border border-white/10 bg-white/5 p-8 shadow-lg">
          <h2 class="text-center font-bold text-2xl md:text-3xl text-amber-300 mb-4">
            Grupo {group}
          </h2>
          <ul id={`group${group}`} class="space-y-2"></ul>
        </div>
      ))}
    </div>

    <!-- LOGOS -->
    <div class="mt-8 max-w-6xl mx-auto grid grid-cols-4 sm:grid-cols-8 lg:grid-cols-16 gap-4">
      {[
        "anti-therian","que-pelota-gerson","desertores-cubicos","fuerza-torales",
        "la-141","los-changos","los-sin-pelo","mate-&-taco",
        "puskas","ss","team-fzbr","therian-&-furious",
        "toxicos-a-la-pala","vasacorrer","x-force","yen"
      ].map((team, i) => (
        <img
          src={`/images/team-logos/${team}.webp`}
          data-team={team}
          alt={`Equipo ${i+1}`}
          class="teamLogo w-full h-auto rounded-lg border border-white/10 hover:scale-110 transition"
        />
      ))}
    </div>

    <!-- OVERLAY -->
    <div id="drawOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 pointer-events-none transition">
      <div id="drawText" class="text-5xl md:text-7xl font-anton text-amber-300 tracking-widest"></div>
    </div>

    <!-- LISTA -->
    <div class="lg:col-span-1">
      <label class="text-lg text-white mb-2 block font-semibold">
        Equipos para el sorteo
      </label>

      <div class="overflow-x-auto">
        <textarea
          id="teamList"
          class="w-full whitespace-nowrap overflow-x-auto overflow-y-hidden rounded-xl border border-white/10 p-3 text-sm focus:outline-none focus:ring-2 focus:ring-amber-400 teamGrid"
          style="height:48px"
        >anti-therian    que-pelota-gerson    desertores-cubicos    fuerza-torales la-141    los-changos    los-sin-pelo    mate-&-taco puskas    ss    team-fzbr    therian-&-furious toxicos-a-la-pala    vasacorrer    x-force    yen</textarea>
      </div>
    </div>

  </section>

<script>
document.addEventListener("DOMContentLoaded", () => {

  let remainingTeams = [];
  let lastDraw = null;

  function getTeams(){
    return document.getElementById("teamList").value
      .replace(/\s+/g,"\n")
      .split("\n")
      .map(t=>t.trim())
      .filter(Boolean);
  }

  function renderTeamGrid(){
    const container = document.getElementById("teamGridPreview");
    container.innerHTML = "";

    getTeams().forEach(team=>{
      const cell = document.createElement("div");
      cell.textContent = team;
      cell.dataset.team = team;
      cell.className = "teamCell bg-white/5 border border-white/10 rounded-lg py-2 text-center text-sm font-semibold";
      container.appendChild(cell);
    });
  }

  renderTeamGrid();
  document.getElementById("teamList").addEventListener("input", renderTeamGrid);

  function loadTeamsIfNeeded(){
    if(remainingTeams.length === 0){
      remainingTeams = getTeams();
    }
  }

  function highlightLogo(team){
    const logo = document.querySelector(`img.teamLogo[data-team="${team}"]`);
    if(!logo) return;
    logo.classList.add("winnerGlow");
    setTimeout(()=>{
      logo.classList.remove("winnerGlow");
      logo.classList.add("logoUsed");
    },2000);
  }

  function markCellUsed(team){
    const cell = document.querySelector(`.teamCell[data-team="${team}"]`);
    if(cell) cell.classList.add("cellUsed");
  }

  function unmarkTeam(team){
    const logo = document.querySelector(`img.teamLogo[data-team="${team}"]`);
    if(logo) logo.classList.remove("logoUsed");

    const cell = document.querySelector(`.teamCell[data-team="${team}"]`);
    if(cell) cell.classList.remove("cellUsed");
  }

  window.drawTeam = function(){

    loadTeamsIfNeeded();
    if(!remainingTeams.length) return alert("No quedan equipos");

    const overlay = document.getElementById("drawOverlay");
    const text = document.getElementById("drawText");
    const group = document.getElementById("groupSelect").value;

    const index = Math.floor(Math.random()*remainingTeams.length);
    const team = remainingTeams[index];

    lastDraw = { team, group };

    overlay.style.display="flex";
    overlay.classList.remove("opacity-0","pointer-events-none");
    overlay.classList.add("opacity-100");

    text.textContent="SORTEANDO...";
    text.classList.add("pulsing");
    text.classList.remove("reveal");

    setTimeout(()=>{
      text.textContent=team;
      text.classList.remove("pulsing");
      text.classList.add("reveal");
      highlightLogo(team);
      markCellUsed(team);
    },1500);

    setTimeout(()=>{
      remainingTeams.splice(index,1);

      const li=document.createElement("li");
      li.textContent=team;
      li.dataset.team=team;
      li.className="bg-white/5 border border-white/10 rounded-lg py-2 text-lg font-semibold text-center drop";

      document.getElementById("group"+group).appendChild(li);
      document.getElementById("result").textContent="Equipo sorteado: "+team;

      overlay.classList.add("opacity-0","pointer-events-none");
      setTimeout(()=>{
        overlay.style.display="none";
        text.textContent="";
        text.classList.remove("reveal","pulsing");
      },300);

    },3000);
  };

  window.undoLastDraw = function(){
    if(!lastDraw) return;

    const { team, group } = lastDraw;

    const list = document.getElementById("group"+group);
    const items = list.querySelectorAll("li");
    if(items.length){
      list.removeChild(items[items.length-1]);
    }

    remainingTeams.push(team);
    unmarkTeam(team);

    document.getElementById("result").textContent="Se deshizo el √∫ltimo sorteo";
    lastDraw = null;
  };

  window.resetDraw = function(){
    remainingTeams=[];
    lastDraw=null;
    document.querySelectorAll(".teamLogo").forEach(l=>l.classList.remove("winnerGlow","logoUsed"));
    document.querySelectorAll(".teamCell").forEach(c=>c.classList.remove("cellUsed"));
    ["A","B","C","D"].forEach(g=>document.getElementById("group"+g).innerHTML="");
    document.getElementById("result").textContent="";
  };

});
</script>

<style>
.teamGrid{font-family: ui-monospace, monospace; white-space: pre; background-color: rgba(255,255,255,0.03);}
.teamCell{transition:.3s;}
.cellUsed{background: rgba(255,255,255,.08); filter: grayscale(100%); opacity:.6;}
.winnerGlow{box-shadow:0 0 25px rgba(255,200,0,.9); transform:scale(1.15);}
.logoUsed{filter:grayscale(100%) brightness(.6); opacity:.7;}
@keyframes dropIn{0%{transform:translateY(-40px);opacity:0}100%{transform:translateY(0);opacity:1}}
.drop{animation:dropIn .5s ease}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.pulsing{animation:pulse 1s infinite}
@keyframes reveal{0%{transform:scale(.7);opacity:0}100%{transform:scale(1);opacity:1}}
.reveal{animation:reveal .4s ease}
</style>

</Layout>
