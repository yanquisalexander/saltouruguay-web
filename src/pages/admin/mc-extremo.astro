---
import AdminPageHeader from "@/components/admin/AdminPageHeader.astro";
import AdminExtremoPlayers from "@/components/admin/AdminExtremoPlayers.tsx";
import { client } from "@/db/client";
import { SaltoCraftExtremo3InscriptionsTable } from "@/db/schema";
import AdminLayout from "@/layouts/AdminLayout.astro";
import { getSession } from "auth-astro/server";
import { desc } from "drizzle-orm";

const session = await getSession(Astro.request);

if (!session?.user.isAdmin) {
  return new Response(null, {
    status: 404,
  });
}

const inscriptos =
  await client.query.SaltoCraftExtremo3InscriptionsTable.findMany({
    orderBy: desc(SaltoCraftExtremo3InscriptionsTable.createdAt),
    with: {
      user: {
        columns: {
          id: true,
          email: true,
          displayName: true,
          avatar: true,
        },
      },
    },
  });
---

<AdminLayout title="Inscripciones Extremo 3" session={session}>
  <div class="flex flex-col max-w-5xl mx-auto min-h-screen mt-16">
    <AdminPageHeader
      title="Inscripciones Extremo 3"
      pathname="/admin/mc-extremo"
    />

    <table class="min-w-full divide-y divide-neutral-800">
      <thead>
        <tr>
          <th
            class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
          >
          </th>
          <th
            class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
          >
          </th>
          <th
            class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
          >
            Discord
          </th>
          <th
            class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
          >
            Fecha de Inscripción
          </th>
          <th
            class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
          >
            ¿Participó anteriormente?
          </th>
          <th
            class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
          >
            Usuario Minecraft
          </th>
        </tr>
      </thead>
      <tbody class="divide-y divide-neutral-800">
        {
          inscriptos.map((inscripto) => (
            <tr>
              <td class="px-4 py-2 text-sm text-gray-200">
                #{inscripto.id.toString().padStart(3, "0")}
              </td>
              <td class="px-4 py-2 text-sm text-gray-200 flex gap-x-2">
                <img
                  src={inscripto.user?.avatar}
                  alt={inscripto.user?.displayName}
                  class="size-5 rounded-full"
                />
                {inscripto.user?.displayName}
              </td>
              <td class="px-4 py-2 text-sm text-gray-200">
                {inscripto.discordUsername}
              </td>
              <td class="px-4 py-2 text-sm text-gray-200">
                {inscripto.createdAt.toLocaleString("es-US", {
                  timeZone: "America/Argentina/Buenos_Aires",
                  hourCycle: "h23",
                })}
              </td>
              <td class="px-4 py-2 text-sm text-gray-200">
                {inscripto.participated_sc?.toUpperCase()}
              </td>
              <td class="px-4 py-2 text-sm text-gray-200">
                {inscripto.minecraft_username}
              </td>
            </tr>
          ))
        }
      </tbody>
    </table>

    <div class="mt-12">
      <AdminExtremoPlayers client:load />
    </div>
  </div>
</AdminLayout>
