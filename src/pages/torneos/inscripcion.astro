---
import Layout from "@/layouts/Layout.astro";
import { getSession } from "auth-astro/server";
import { client as db } from "@/db/client";
import { RocketLeagueRegistrationsTable } from "@/db/schema";
import { eq } from "drizzle-orm";

const session = await getSession(Astro.request);
const user = session?.user;

// üëâ Verificar si ya est√° inscrito
let alreadyRegistered = false;

if (user) {
  const existing = await db.query.RocketLeagueRegistrationsTable.findFirst({
    where: eq(RocketLeagueRegistrationsTable.userId, Number(user.id)),
  });

  alreadyRegistered = !!existing;
}
---

<Layout
  title="Inscripci√≥n Rocket League | Salto Uruguay"
  description="Formulario de inscripci√≥n para el torneo de Rocket League"
>
  <div class="container mx-auto px-4 py-16 max-w-3xl">

    <h1 class="text-4xl font-anton text-white mb-6 text-center">
      Inscripci√≥n Torneo Rocket League
    </h1>

    {
      alreadyRegistered ? (
        <div class="bg-green-500/10 border border-green-500/30 text-green-400 p-6 rounded-2xl text-center">
          ‚úÖ Ya est√°s inscrito en el torneo
        </div>
      ) : (
        <form
          id="rocketForm"
          class="space-y-6 bg-white/5 p-8 rounded-3xl border border-white/10"
        >
          <div>
            <label class="block text-white/70 mb-2">Usuario de Discord</label>
            <input
              name="discordUsername"
              required
              class="w-full px-4 py-3 rounded-xl bg-black/40 border border-white/10 text-white"
              placeholder="Ej: usuario#1234"
            />
          </div>

          <div>
            <label class="block text-white/70 mb-2">ID de Rocket League</label>
            <input
              name="rocketId"
              required
              class="w-full px-4 py-3 rounded-xl bg-black/40 border border-white/10 text-white"
              placeholder="Ej: Player123"
            />
          </div>

          <div>
            <label class="block text-white/70 mb-2">Plataforma</label>
            <select
              name="platform"
              required
              class="w-full px-4 py-3 rounded-xl bg-black/40 border border-white/10 text-white"
            >
              <option value="">Seleccionar</option>
              <option value="PC">PC</option>
              <option value="PlayStation">PlayStation</option>
              <option value="Xbox">Xbox</option>
              <option value="Switch">Nintendo Switch</option>
            </select>
          </div>

          <div>
            <label class="block text-white/70 mb-2">
              Nombre del equipo (opcional)
            </label>
            <input
              name="teamName"
              class="w-full px-4 py-3 rounded-xl bg-black/40 border border-white/10 text-white"
              placeholder="Ej: Team Salto"
            />
          </div>

          <div class="flex items-center gap-3">
            <input type="checkbox" name="terms" required class="w-4 h-4" />
            <span class="text-white/70 text-sm">
              Acepto las reglas del torneo
            </span>
          </div>

          <button
            type="submit"
            class="w-full py-4 rounded-2xl bg-gradient-to-r from-orange-500 to-fuchsia-600 
            hover:from-orange-400 hover:to-fuchsia-500 text-white font-bold 
            uppercase tracking-wide shadow-lg transition"
          >
            Confirmar inscripci√≥n
          </button>

          <p id="formMessage" class="text-center text-sm text-white/60"></p>
        </form>
      )
    }
  </div>

  <script>
    const form = document.getElementById("rocketForm");
    const message = document.getElementById("formMessage");

    if (form) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        message.textContent = "Enviando inscripci√≥n‚Ä¶";

        const formData = new FormData(form);

        const discordUsername = formData.get("discordUsername");
        const rocketId = formData.get("rocketId");
        const platform = formData.get("platform");
        const teamName = formData.get("teamName");
        const acceptedTerms = formData.get("terms") === "on";

        try {
          const res = await fetch("/api/rocket-league/register", {
            method: "POST",
            body: JSON.stringify({
              discordUsername,
              rocketId,
              platform,
              teamName,
              acceptedTerms,
            }),
            headers: { "Content-Type": "application/json" },
          });

          if (res.ok) {
            message.textContent = "‚úÖ Inscripci√≥n completada con √©xito";
            form.reset();
          } else {
            message.textContent = "‚ùå Error al enviar la inscripci√≥n";
          }
        } catch {
          message.textContent = "‚ùå Error de conexi√≥n";
        }
      });
    }
  </script>
</Layout>
