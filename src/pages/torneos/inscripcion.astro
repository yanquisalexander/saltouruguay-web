---
import Layout from "@/layouts/Layout.astro";
import { getSession } from "auth-astro/server";
import { client } from "@/db/client";
import { RocketLeagueTournamentTable } from "@/db/schema"; //  tu tabla
import { eq } from "drizzle-orm";

import {
  LucideMail,
  LucideMessageSquare,
  LucideGamepad2,
  LucideUsers,
  LucideCheckCircle,
  LucideArrowLeft,
  LucideSend,
  LucideLock,
  LucideInfo,
} from "lucide-preact";

const session = await getSession(Astro.request);

const isInscribed = session?.user?.id
  ? await client
      .select()
      .from(RocketLeagueTournamentTable)
      .where(eq(RocketLeagueTournamentTable.userId, session.user.id))
      .execute()
      .then((res) => res.length > 0)
  : false;

const cardClass =
  "relative overflow-hidden rounded-3xl border border-white/10 bg-black/40 backdrop-blur-md p-8 shadow-2xl transition-all hover:border-indigo-500/30";

const inputClass =
  "appearance-none block w-full px-4 py-3 border border-white/10 rounded-xl bg-white/5 shadow-sm placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500/50 sm:text-sm text-white transition-all hover:bg-white/10";
---

<Layout title="Inscripci贸n Torneo Rocket League">
  <div class="flex flex-col max-w-3xl mx-auto min-h-screen pt-24 px-4 pb-20">

    <a href="/torneo" class="inline-flex items-center gap-2 text-white/60 hover:text-white mb-8">
      <LucideArrowLeft size={20} />
      Volver
    </a>

    <main class={cardClass}>

      {
        !session ? (
          <div class="flex flex-col items-center text-center py-12 space-y-4">
            <LucideLock size={48} class="text-indigo-400" />
            <h2 class="text-2xl font-bold text-white">Debes iniciar sesi贸n</h2>
            <p class="text-white/60">Para inscribirte al torneo</p>
          </div>

        ) : isInscribed ? (
          <div class="flex flex-col items-center text-center py-12 space-y-4">
            <LucideCheckCircle size={48} class="text-indigo-400" />
            <h2 class="text-2xl font-bold text-white">Ya est谩s inscripto</h2>
            <p class="text-white/60">Tu inscripci贸n ya fue registrada</p>
          </div>

        ) : (
          <form class="space-y-8">

            <div class="grid sm:grid-cols-2 gap-6">

              <div class="space-y-2">
                <label class="text-sm font-bold text-white/80 uppercase">
                  Correo electr贸nico
                </label>
                <input
                  type="email"
                  value={session.user.email}
                  readonly
                  class={inputClass}
                />
              </div>

              <div class="space-y-2">
                <label class="text-sm font-bold text-white/80 uppercase">
                  Usuario Discord
                </label>
                <input
                  type="text"
                  name="discord"
                  required
                  placeholder="usuario#0000"
                  class={inputClass}
                />
              </div>

              <div class="space-y-2">
                <label class="text-sm font-bold text-white/80 uppercase">
                  Usuario Rocket League
                </label>
                <input
                  type="text"
                  name="rocketLeague"
                  required
                  placeholder="Tu Epic ID"
                  class={inputClass}
                />
              </div>

              <div class="space-y-2">
                <label class="text-sm font-bold text-white/80 uppercase">
                  Compa帽ero (Opcional)
                </label>
                <input
                  type="text"
                  name="teammate"
                  placeholder="Nombre o ID"
                  class={inputClass}
                />
              </div>

            </div>

            <div class="p-4 rounded-xl bg-white/5 border border-white/10 flex gap-3">
              <input type="checkbox" name="terms" required class="mt-1" />
              <span class="text-sm text-white/70">
                Acepto las reglas del torneo
              </span>
            </div>

            <button
              type="submit"
              id="submit-btn"
              class="w-full flex items-center justify-center gap-3 py-4 bg-indigo-600 hover:bg-indigo-500 rounded-xl font-bold uppercase"
            >
              <LucideSend size={20} />
              Enviar inscripci贸n
            </button>

          </form>
        )
      }

    </main>
  </div>
</Layout>

<script>
  import { $ } from "@/lib/dom-selector";
  import { actions } from "astro:actions";
  import { toast } from "sonner";
  import { navigate } from "astro:transitions/client";

  document.addEventListener("astro:page-load", () => {
    const $form = $("form");
    const $btn = $("#submit-btn");

    $form?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const data = new FormData($form);

      $btn.disabled = true;

      const { error } = await actions.torneo.inscribirse({
        discord: data.get("discord"),
        rocketLeague: data.get("rocketLeague"),
        teammate: data.get("teammate"),
        acceptedTerms: data.get("terms") === "on",
      });

      if (error) {
        toast.error(error.message || "Error al inscribirse");
        $btn.disabled = false;
        return;
      }

      toast.success("Inscripci贸n enviada ");
      setTimeout(() => navigate("/torneo"), 1500);
    });
  });
</script>
