---
import Layout from "@/layouts/Layout.astro";
import { getSession } from "auth-astro/server";

// ðŸ”¢ funciÃ³n de cÃ¡lculo
const calcular = (teams: any[]) =>
  (teams || [])
    .map((t) => {
      const PG = t.PG || 0;
      const PP = t.PP || 0;
      const GF = t.GF || 0;
      const GC = t.GC || 0;

      return {
        ...t,
        PJ: PG + PP,
        DG: GF - GC,
      };
    })
    .sort(
      (a, b) =>
        (b.PUNTOS || 0) - (a.PUNTOS || 0) ||
        (b.DG || 0) - (a.DG || 0) ||
        (b.GF || 0) - (a.GF || 0),
    );

// ðŸ” sesiÃ³n admin
const session = await getSession(Astro.request);
const isAdmin =
  (session?.user as any)?.admin === true ||
  (session?.user as any)?.isAdmin === true;

// ðŸ“Š obtener tabla calculada + partidos
let tablaData: any = {};

try {
  const res = await fetch(`${Astro.url.origin}/api/obtener-tabla`);
  tablaData = await res.json();
} catch (err) {
  console.error("Error cargando tabla", err);
}

// ðŸ“¦ grupos
const grupos = ["A", "B", "C", "D"].map((g) => ({
  grupo: g,
  equipos: calcular(tablaData[g] || []),
}));
---

<Layout
  hideHeader
  title="Tabla de Posiciones"
  mainClassname="px-6 sm:px-10 pt-24 pb-32"
>
  <section class="max-w-7xl mx-auto">
    <!-- TITULO -->
    <div class="text-center mb-12">
      <p class="uppercase tracking-[0.1em] text-4xl md:text-6xl font-anton font-bold mb-2 text-white drop-shadow-lg">
        TORNEO ROCKET LEAGUE
      </p>

      <h1 class="font-anton text-4xl md:text-5xl mt-2 bg-gradient-to-r from-amber-400 to-yellow-300 bg-clip-text text-transparent">
        Tabla de Posiciones
      </h1>
    </div>

    <!-- TABLAS -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-6">
      {
        grupos.map(({ grupo, equipos }) => (
          <div class="rounded-2xl border border-white/10 bg-white/5 p-8 shadow-lg">
            <h2 class="text-center font-bold text-2xl md:text-3xl text-amber-300 mb-6">
              GRUPO {grupo}
            </h2>

            <div class="overflow-x-auto">
              <table class="w-full border-collapse text-sm">
                <thead>
                  <tr class="bg-white/10 text-white">
                    <th class="text-center px-3 py-2 border border-white/10">POS</th>
                    <th class="text-left px-3 py-2 border border-white/10">Equipo</th>
                    <th class="text-center px-3 py-2 border border-white/10">PJ</th>
                    <th class="text-center px-3 py-2 border border-white/10">PG</th>
                    <th class="text-center px-3 py-2 border border-white/10">PP</th>
                    <th class="text-center px-3 py-2 border border-white/10">GF</th>
                    <th class="text-center px-3 py-2 border border-white/10">GC</th>
                    <th class="text-center px-3 py-2 border border-white/10">DG</th>
                    <th class="text-center px-3 py-2 border border-white/10 font-bold">PTS</th>
                  </tr>
                </thead>

                <tbody>
                  {equipos.map((team, i) => (
                    <tr class={i < 2 ? "bg-green-500/20" : "bg-red-500/20"}>
                      <td class="px-3 py-2 border border-white/10 text-center font-bold">
                        {i === 0 ? "ðŸ¥‡" : i === 1 ? "ðŸ¥ˆ" : i + 1}
                      </td>
                      <td class="px-3 py-2 border border-white/10 text-left">
                        {team.equipo}
                      </td>
                      <td class="px-3 py-2 border border-white/10 text-center">{team.PJ}</td>
                      <td class="px-3 py-2 border border-white/10 text-center">{team.PG}</td>
                      <td class="px-3 py-2 border border-white/10 text-center">{team.PP}</td>
                      <td class="px-3 py-2 border border-white/10 text-center">{team.GF}</td>
                      <td class="px-3 py-2 border border-white/10 text-center">{team.GC}</td>
                      <td class="px-3 py-2 border border-white/10 text-center">{team.DG}</td>
                      <td class="px-3 py-2 border border-white/10 text-center font-bold">{team.PUNTOS}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            <!-- LISTA DE PARTIDOS -->
            <div class="mt-4 text-sm text-white/80">
              <h3 class="font-bold mb-2">Partidos</h3>

              {(tablaData._partidos?.[grupo] || []).length === 0 && (
                <p class="text-white/50">Sin partidos</p>
              )}

              {(tablaData._partidos?.[grupo] || []).map((p) => (
                <div class="flex items-center justify-between border-b border-white/10 py-1">
                  <span class="text-xs opacity-60">{p.id}</span>

                  <span class="flex-1 text-center">
                    {p.local} <b>{p.golesLocal} - {p.golesVisitante}</b> {p.visitante}
                  </span>
                </div>
              ))}
            </div>
          </div>
        ))
      }
    </div>

    <!-- PANEL ADMIN -->
    {isAdmin && (
      <div class="mt-16">
        <h2 class="text-xl font-bold text-white mb-4">Cargar resultado</h2>

        <div class="flex flex-wrap gap-2">
          <select id="grupo" class="p-2 bg-zinc-800 text-white rounded">
            <option>A</option>
            <option>B</option>
            <option>C</option>
            <option>D</option>
          </select>

          <input id="local" placeholder="Equipo local" class="p-2 bg-zinc-800 text-white rounded"/>
          <input id="visitante" placeholder="Equipo visitante" class="p-2 bg-zinc-800 text-white rounded"/>
          <input id="gl" type="number" placeholder="Goles local" class="p-2 bg-zinc-800 text-white rounded"/>
          <input id="gv" type="number" placeholder="Goles visitante" class="p-2 bg-zinc-800 text-white rounded"/>

          <button id="guardarPartido" class="px-4 py-2 bg-emerald-500 rounded hover:bg-emerald-600">
            Guardar partido
          </button>
        </div>
      </div>
    )}
  </section>

  {isAdmin && (
    <script>
      function generarId() {
        return "match_" + Date.now() + "_" + Math.floor(Math.random() * 10000);
      }

      document.getElementById("guardarPartido").addEventListener("click", async () => {
        const payload = {
          id: generarId(),
          grupo: document.getElementById("grupo").value,
          local: document.getElementById("local").value,
          visitante: document.getElementById("visitante").value,
          golesLocal: Number(document.getElementById("gl").value),
          golesVisitante: Number(document.getElementById("gv").value)
        };

        await fetch("/api/partidos", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        location.reload();
      });
    </script>
  )}
</Layout>
