---
import Layout from "@/layouts/Layout.astro";
import tabla from "@/data/tabla-posiciones.json";
import { getSession } from "auth-astro/server";
import redis from "@/lib/redis";

const calcular = (teams: any[]) =>
  (teams || [])
    .map((t) => {
      const PG = t.PG || 0;
      const PP = t.PP || 0;
      const GF = t.GF || 0;
      const GC = t.GC || 0;

      return {
        ...t,
        PJ: PG + PP,
        DG: GF - GC,
      };
    })
    .sort(
      (a, b) =>
        (b.PUNTOS || 0) - (a.PUNTOS || 0) ||
        (b.DG || 0) - (a.DG || 0) ||
        (b.GF || 0) - (a.GF || 0),
    );

const session = await getSession(Astro.request);
const isAdmin =
  (session?.user as any)?.admin === true ||
  (session?.user as any)?.isAdmin === true;

let tablaData: any = tabla;
const redisKeyTabla = "tournament:rocket-league:tabla-posiciones";
const redisKeyPartidos = "tournament:rocket-league:partidos";

let partidos: any = { A: [], B: [], C: [], D: [] };

try {
  const storedTabla = await redis.get(redisKeyTabla);
  if (storedTabla) tablaData = JSON.parse(storedTabla);

  try {
  const res = await fetch(new URL("/api/partidos", Astro.url));
  partidos = await res.json();
} catch (err) {
  console.error("Error cargando partidos", err);
}
} catch (err) {
  console.error("Redis error", err);
}

const resetStats = (teams) =>
  teams.map(t => ({ ...t, PG:0, PP:0, GF:0, GC:0, PUNTOS:0 }));

for (const grupo of ["A","B","C","D"]) {
  tablaData[grupo] = resetStats(tablaData[grupo] || []);

  for (const p of partidos[grupo] || []) {
    const local = tablaData[grupo].find(t => t.equipo === p.local);
    const visitante = tablaData[grupo].find(t => t.equipo === p.visitante);

    if (!local || !visitante) continue;

    local.GF += p.golesLocal;
    local.GC += p.golesVisitante;

    visitante.GF += p.golesVisitante;
    visitante.GC += p.golesLocal;

    if (p.golesLocal > p.golesVisitante) {
      local.PG++; local.PUNTOS += 3;
      visitante.PP++;
    } else if (p.golesLocal < p.golesVisitante) {
      visitante.PG++; visitante.PUNTOS += 3;
      local.PP++;
    }
  }
}

const grupos = ["A", "B", "C", "D"].map((g) => ({
  grupo: g,
  equipos: calcular(tablaData[g]),
}));
---

<Layout hideHeader title="Tabla de Posiciones" mainClassname="px-6 sm:px-10 pt-24 pb-32">
<section class="max-w-7xl mx-auto">

  <div class="text-center mb-12">
    <p class="uppercase tracking-[0.1em] text-4xl md:text-6xl font-anton font-bold mb-2 text-white drop-shadow-lg">
      TORNEO ROCKET LEAGUE
    </p>

    <h1 class="font-anton text-4xl md:text-5xl mt-2 bg-gradient-to-r from-amber-400 to-yellow-300 bg-clip-text text-transparent">
      Tabla de Posiciones
    </h1>
  </div>

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-6">
  {
    grupos.map(({ grupo, equipos }) => (
      <div class="rounded-2xl border border-white/10 bg-white/5 p-8 shadow-lg">
        <h2 class="text-center font-bold text-2xl md:text-3xl text-amber-300 mb-6">
          GRUPO {grupo}
        </h2>

        <div class="overflow-x-auto">
          <table class="w-full border-collapse text-sm">
            <thead>
              <tr class="bg-white/10 text-white">
                <th class="text-center px-3 py-2 border border-white/10">POS</th>
                <th class="text-left px-3 py-2 border border-white/10">Equipo</th>
                <th class="text-center px-3 py-2 border border-white/10">PJ</th>
                <th class="text-center px-3 py-2 border border-white/10">PG</th>
                <th class="text-center px-3 py-2 border border-white/10">PP</th>
                <th class="text-center px-3 py-2 border border-white/10">GF</th>
                <th class="text-center px-3 py-2 border border-white/10">GC</th>
                <th class="text-center px-3 py-2 border border-white/10">DG</th>
                <th class="text-center px-3 py-2 border border-white/10 font-bold">PTS</th>
              </tr>
            </thead>

            <tbody>
              {equipos.map((team, i) => (
                <tr class={i < 2 ? "bg-green-500/20" : "bg-red-500/20"}>
                  <td class="px-3 py-2 border border-white/10 text-center font-bold">
                    {i === 0 ? "ü•á" : i === 1 ? "ü•à" : i + 1}
                  </td>
                  <td class="px-3 py-2 border border-white/10 text-left">{team.equipo}</td>
                  <td class="px-3 py-2 border border-white/10 text-center">{team.PJ}</td>
                  <td class="px-3 py-2 border border-white/10 text-center">{team.PG}</td>
                  <td class="px-3 py-2 border border-white/10 text-center">{team.PP}</td>
                  <td class="px-3 py-2 border border-white/10 text-center">{team.GF}</td>
                  <td class="px-3 py-2 border border-white/10 text-center">{team.GC}</td>
                  <td class="px-3 py-2 border border-white/10 text-center">{team.DG}</td>
                  <td class="px-3 py-2 border border-white/10 text-center">{team.PUNTOS}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {isAdmin && (
          <div class="mt-4 text-xs text-white/70 space-y-1">
            <p class="font-bold mb-1">Partidos cargados</p>

            {(partidos[grupo] || []).map(p => (
              <div class="flex items-center gap-2">
                <span class="flex-1">
                  {p.local} {p.golesLocal} - {p.golesVisitante} {p.visitante}
                </span>

                <button class="edit-btn px-2 py-1 bg-amber-500/80 rounded text-black text-xs" data-id={p.id}>‚úèÔ∏è</button>
                <button class="delete-btn px-2 py-1 bg-red-500/80 rounded text-white text-xs" data-id={p.id}>üóëÔ∏è</button>
              </div>
            ))}
          </div>
        )}

      </div>
    ))
  }
  </div>

</section>

{isAdmin && (
<script>
document.querySelectorAll(".delete-btn").forEach(btn => {
  btn.addEventListener("click", async () => {
    const id = btn.dataset.id;
    if (!confirm("Eliminar partido?")) return;

    await fetch("/api/partidos", {
      method: "DELETE",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id })
    });

    location.reload();
  });
});

document.querySelectorAll(".edit-btn").forEach(btn => {
  btn.addEventListener("click", async () => {
    const id = btn.dataset.id;

    const golesLocal = prompt("Nuevo score local");
    const golesVisitante = prompt("Nuevo score visitante");

    if (golesLocal === null || golesVisitante === null) return;

    await fetch("/api/partidos", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        id,
        golesLocal: Number(golesLocal),
        golesVisitante: Number(golesVisitante)
      })
    });

    location.reload();
  });
});
</script>
)}

</Layout>
