---
import Layout from "@/layouts/Layout.astro";
import tabla from "@/data/tabla-posiciones.json";
import { getSession } from "auth-astro/server";

const session = await getSession(Astro.request);
const isAdmin =
  (session?.user as any)?.admin === true ||
  (session?.user as any)?.isAdmin === true;

// Funci√≥n para calcular PJ y DG din√°micamente
const calcular = (teams: any[]) =>
  (teams || [])
    .map((t) => ({
      ...t,
      PJ: (t.PG || 0) + (t.PE || 0) + (t.PP || 0),
      DG: (t.GF || 0) - (t.GC || 0),
    }))
    .sort(
      (a, b) =>
        (b.PUNTOS || 0) - (a.PUNTOS || 0) ||
        (b.DG || 0) - (a.DG || 0) ||
        (b.GF || 0) - (a.GF || 0)
    );

let tablaData: any = JSON.parse(JSON.stringify(tabla)); // Clon profundo para evitar mutar el original
let partidos: any = { A: [], B: [], C: [], D: [] };

try {
  // 1. Intentar cargar base de tabla desde el endpoint (usa cache internamente)
  // Solo reemplaza el fallback JSON si la cache tiene equipos reales
  const tablaResp = await fetch(new URL("/api/tabla-posiciones", Astro.url));
  if (tablaResp.ok) {
    const apiData = await tablaResp.json();
    const hasData = Object.values(apiData as Record<string, any[]>).some((arr) => arr.length > 0);
    if (hasData) tablaData = apiData;
  }

  // 2. Cargar partidos desde la API
  try {
    const res = await fetch(new URL("/api/partidos", Astro.url));
    if (res.ok) partidos = await res.json();
  } catch (err) {
    console.error("Error cargando partidos desde API", err);
  }
} catch (err) {
  console.error("Error cargando tabla de posiciones desde API", err);
}

// 3. Resetear estad√≠sticas temporales para recalcular con los partidos actuales
const resetStats = (teams: any[]) =>
  teams.map((t) => ({ ...t, PG: 0, PE: 0, PP: 0, GF: 0, GC: 0, PUNTOS: 0 }));

// 4. Procesar resultados de los partidos en la tabla
for (const grupo of ["A", "B", "C", "D"]) {
  tablaData[grupo] = resetStats(tablaData[grupo] || []);

  for (const p of partidos[grupo] || []) {
    const local = tablaData[grupo].find((t: any) => t.equipo === p.local);
    const visitante = tablaData[grupo].find((t: any) => t.equipo === p.visitante);

    if (!local || !visitante) continue;

    local.GF += p.golesLocal;
    local.GC += p.golesVisitante;
    visitante.GF += p.golesVisitante;
    visitante.GC += p.golesLocal;

    if (p.golesLocal > p.golesVisitante) {
      local.PG++;
      local.PUNTOS += 3;
      visitante.PP++;
    } else if (p.golesLocal < p.golesVisitante) {
      visitante.PG++;
      visitante.PUNTOS += 3;
      local.PP++;
    } else {
      local.PE++;
      local.PUNTOS += 1;
      visitante.PE++;
      visitante.PUNTOS += 1;
    }
  }
}

const gruposFinales = ["A", "B", "C", "D"].map((g) => ({
  grupo: g,
  equipos: calcular(tablaData[g]),
}));
---

<Layout hideHeader title="Tabla de Posiciones" mainClassname="px-6 sm:px-10 pt-24 pb-32">
  <section class="max-w-7xl mx-auto">
    <div class="text-center mb-12">
      <p class="uppercase tracking-[0.1em] text-4xl md:text-6xl font-anton font-bold mb-2 text-white drop-shadow-lg">
        TORNEO ROCKET LEAGUE
      </p>
      <h1 class="font-anton text-4xl md:text-5xl mt-2 bg-gradient-to-r from-amber-400 to-yellow-300 bg-clip-text text-transparent">
        Tabla de Posiciones
      </h1>
    </div>

    {isAdmin && (
      <div class="text-center mb-8">
        <button
          id="resetBtn"
          class="bg-red-600 hover:bg-red-500 text-white font-bold px-6 py-2 rounded-lg shadow-lg transition-all active:scale-95"
        >
          üîÑ Resetear Torneo Completo
        </button>
      </div>
    )}

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      {gruposFinales.map(({ grupo, equipos }) => (
        <div class="rounded-2xl border border-white/10 bg-white/5 p-6 shadow-xl backdrop-blur-sm">
          <h2 class="text-center font-bold text-3xl text-amber-300 mb-6 font-anton tracking-wider">
            GRUPO {grupo}
          </h2>

          <div class="overflow-x-auto">
            <table class="w-full border-collapse text-sm mb-6">
              <thead>
                <tr class="bg-white/10 text-white uppercase text-xs">
                  <th class="px-2 py-3 border border-white/10">POS</th>
                  <th class="text-left px-3 py-3 border border-white/10">Equipo</th>
                  <th class="px-2 py-3 border border-white/10 text-center text-amber-300">PTS</th>
                  <th class="px-2 py-3 border border-white/10 text-center">PJ</th>
                  <th class="px-2 py-3 border border-white/10 text-center">PG</th>
                  <th class="px-2 py-3 border border-white/10 text-center">PE</th>
                  <th class="px-2 py-3 border border-white/10 text-center">PP</th>
                  <th class="px-2 py-3 border border-white/10 text-center">DG</th>
                </tr>
              </thead>
              <tbody>
                {equipos.map((team, i) => (
                  <tr class={i < 2 ? "bg-green-500/10 hover:bg-green-500/20" : "bg-red-500/10 hover:bg-red-500/20"}>
                    <td class="px-2 py-2 border border-white/10 text-center font-bold">
                      {i === 0 ? "ü•á" : i === 1 ? "ü•à" : i + 1}
                    </td>
                    <td class="px-3 py-2 border border-white/10 text-left font-medium">{team.equipo}</td>
                    <td class="px-2 py-2 border border-white/10 text-center font-bold text-amber-300">{team.PUNTOS}</td>
                    <td class="px-2 py-2 border border-white/10 text-center">{team.PJ}</td>
                    <td class="px-2 py-2 border border-white/10 text-center text-green-400">{team.PG}</td>
                    <td class="px-2 py-2 border border-white/10 text-center text-yellow-400">{team.PE}</td>
                    <td class="px-2 py-2 border border-white/10 text-center text-red-400">{team.PP}</td>
                    <td class="px-2 py-2 border border-white/10 text-center text-white/60">{team.DG}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {isAdmin && (
            <div class="mt-4 border-t border-white/10 pt-4 space-y-4">

              {/* ‚îÄ‚îÄ Cargar nuevo resultado ‚îÄ‚îÄ */}
              <details class="group/form">
                <summary class="cursor-pointer list-none flex items-center gap-2 text-xs font-bold text-green-400/90 uppercase tracking-widest select-none">
                  <span class="group-open/form:rotate-90 transition-transform">‚ñ∂</span>
                  Cargar resultado
                </summary>
                <form
                  class="add-match-form mt-3 flex flex-col gap-2"
                  data-grupo={grupo}
                  data-equipos={JSON.stringify(equipos.map((e: any) => e.equipo))}
                >
                  <div class="grid grid-cols-2 gap-2">
                    <div class="flex flex-col gap-1">
                      <label class="text-white/50 text-xs">Local</label>
                      <select name="local" class="bg-black/50 border border-white/10 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:ring-1 focus:ring-amber-400">
                        {equipos.map((e: any) => <option value={e.equipo}>{e.equipo}</option>)}
                      </select>
                    </div>
                    <div class="flex flex-col gap-1">
                      <label class="text-white/50 text-xs">Visitante</label>
                      <select name="visitante" class="bg-black/50 border border-white/10 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:ring-1 focus:ring-amber-400">
                        {equipos.map((e: any) => <option value={e.equipo}>{e.equipo}</option>)}
                      </select>
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-2">
                    <div class="flex flex-col gap-1">
                      <label class="text-white/50 text-xs">Goles Local</label>
                      <input name="golesLocal" type="number" min="0" value="0"
                        class="bg-black/50 border border-white/10 rounded px-2 py-1.5 text-sm text-white text-center focus:outline-none focus:ring-1 focus:ring-amber-400" />
                    </div>
                    <div class="flex flex-col gap-1">
                      <label class="text-white/50 text-xs">Goles Visitante</label>
                      <input name="golesVisitante" type="number" min="0" value="0"
                        class="bg-black/50 border border-white/10 rounded px-2 py-1.5 text-sm text-white text-center focus:outline-none focus:ring-1 focus:ring-amber-400" />
                    </div>
                  </div>
                  <button type="submit"
                    class="mt-1 w-full bg-green-600 hover:bg-green-500 active:scale-95 transition text-white text-sm font-bold py-2 rounded-lg">
                    ‚ûï Guardar partido
                  </button>
                </form>
              </details>

              {/* ‚îÄ‚îÄ Partidos registrados ‚îÄ‚îÄ */}
              <div>
                <p class="text-xs font-bold text-amber-400/80 uppercase tracking-widest mb-3">Partidos Registrados</p>
                <div class="space-y-2">
                  {(partidos[grupo] || []).map((p: any) => (
                    <div class="flex items-center justify-between bg-black/40 p-3 rounded-lg border border-white/5">
                      <span class="text-white text-sm">
                        <span class="font-bold">{p.local}</span> {p.golesLocal} - {p.golesVisitante} <span class="font-bold">{p.visitante}</span>
                      </span>
                      <div class="flex gap-2">
                        <button
                          class="edit-btn bg-amber-500 hover:bg-amber-400 text-black p-1.5 rounded transition-colors"
                          data-id={p.id}
                          title="Editar resultado"
                        >
                          ‚úèÔ∏è
                        </button>
                        <button
                          class="delete-btn bg-red-600 hover:bg-red-500 text-white p-1.5 rounded transition-colors"
                          data-id={p.id}
                          title="Eliminar partido"
                        >
                          üóëÔ∏è
                        </button>
                      </div>
                    </div>
                  ))}
                  {(!partidos[grupo] || partidos[grupo].length === 0) && (
                    <p class="text-white/30 text-xs italic">No hay partidos cargados</p>
                  )}
                </div>
              </div>

            </div>
          )}
        </div>
      ))}
    </div>
  </section>
</Layout>

{isAdmin && (
<script>
  // ‚îÄ‚îÄ Cargar nuevo partido ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.querySelectorAll(".add-match-form").forEach(form => {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const f = form as HTMLFormElement;
      const grupo = f.dataset.grupo!;
      const local = (f.querySelector("[name=local]") as HTMLSelectElement).value;
      const visitante = (f.querySelector("[name=visitante]") as HTMLSelectElement).value;
      const golesLocal = Number((f.querySelector("[name=golesLocal]") as HTMLInputElement).value);
      const golesVisitante = Number((f.querySelector("[name=golesVisitante]") as HTMLInputElement).value);

      if (local === visitante) { alert("Local y visitante no pueden ser el mismo equipo."); return; }

      const btn = f.querySelector("button[type=submit]") as HTMLButtonElement;
      btn.disabled = true;
      btn.textContent = "Guardando‚Ä¶";

      try {
        const res = await fetch("/api/partidos", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ grupo, local, visitante, golesLocal, golesVisitante })
        });
        if (res.ok) location.reload();
        else alert("Error al guardar partido");
      } catch (err) {
        console.error(err);
        alert("Error de red");
      } finally {
        btn.disabled = false;
        btn.textContent = "‚ûï Guardar partido";
      }
    });
  });

  // ‚îÄ‚îÄ Borrado individual ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = (btn as HTMLElement).dataset.id;
      if (!confirm("¬øEliminar este partido? Esto afectar√° la tabla inmediatamente.")) return;

      try {
        const res = await fetch("/api/partidos", {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id })
        });
        if (res.ok) location.reload();
        else alert("Error al borrar");
      } catch (e) {
        console.error(e);
      }
    });
  });

  // Manejo de Edici√≥n Individual
  document.querySelectorAll(".edit-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = (btn as HTMLElement).dataset.id;
      const golesLocal = prompt("Nuevo score LOCAL:");
      const golesVisitante = prompt("Nuevo score VISITANTE:");

      if (golesLocal === null || golesVisitante === null) return;

      try {
        const res = await fetch("/api/partidos", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id,
            golesLocal: Number(golesLocal),
            golesVisitante: Number(golesVisitante)
          })
        });
        if (res.ok) location.reload();
        else alert("Error al actualizar");
      } catch (e) {
        console.error(e);
      }
    });
  });

  // Manejo de Reset Total
  const resetBtn = document.querySelector("#resetBtn");
  if (resetBtn) {
    resetBtn.addEventListener("click", async () => {
      if (!confirm("‚ö†Ô∏è ¬øEST√ÅS SEGURO? Se borrar√°n TODOS los partidos de todos los grupos.")) return;

      try {
        const res = await fetch("/api/reset-torneo", { method: "POST" });
        if (res.ok) location.reload();
        else alert("Error al resetear");
      } catch (e) {
        console.error(e);
      }
    });
  }
</script>
)}
