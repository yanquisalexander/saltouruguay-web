---
import Layout from "@/layouts/Layout.astro";
import tabla from "@/data/tabla-posiciones.json";
import { getSession } from "auth-astro/server";
import redis from "@/lib/redis";

const calcular = (teams: any[]) =>
  (teams || [])
    .map((t) => {
      const PG = t.PG || 0;
      const PP = t.PP || 0;
      const GF = t.GF || 0;
      const GC = t.GC || 0;

      return {
        ...t,
        PJ: PG + PP,
        DG: GF - GC,
      };
    })
    .sort(
      (a, b) =>
        (b.PUNTOS || 0) - (a.PUNTOS || 0) ||
        (b.DG || 0) - (a.DG || 0) ||
        (b.GF || 0) - (a.GF || 0),
    );

// admin info & dynamic data load
const session = await getSession(Astro.request);
const isAdmin =
  (session?.user as any)?.admin === true ||
  (session?.user as any)?.isAdmin === true;

// attempt to override default tabla with redis-stored value
let tablaData: any = tabla;
const redisKey = "tournament:rocket-league:tabla-posiciones";
try {
  const stored = await redis.get(redisKey);
  if (stored) {
    tablaData = JSON.parse(stored);
  }
} catch (err) {
  console.error("Error reading tabla-posiciones from redis", err);
}

const grupos = ["A", "B", "C", "D"].map((g) => ({
  grupo: g,
  equipos: calcular(tablaData[g as keyof typeof tablaData] || []),
}));
---

<Layout
  hideHeader
  title="Tabla de Posiciones"
  mainClassname="px-6 sm:px-10 pt-24 pb-32"
>
  <section class="max-w-7xl mx-auto">
    <!-- TITULO -->
    <div class="text-center mb-12">
      <p
        class="uppercase tracking-[0.1em] text-4xl md:text-6xl font-anton font-bold mb-2 text-white drop-shadow-lg"
      >
        TORNEO ROCKET LEAGUE
      </p>

      <h1
        class="font-anton text-4xl md:text-5xl mt-2 bg-gradient-to-r from-amber-400 to-yellow-300 bg-clip-text text-transparent"
      >
        Tabla de Posiciones
      </h1>
    </div>

    <!-- TABLAS -->
    
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-6">
      {
        grupos.map(({ grupo, equipos }) => (
          <div class="rounded-2xl border border-white/10 bg-white/5 p-8 shadow-lg">
            <h2 class="text-center font-bold text-2xl md:text-3xl text-amber-300 mb-6">
              GRUPO {grupo}
            </h2>

            <div class="overflow-x-auto">
              <table class="w-full border-collapse text-sm">
                <thead>
                  <tr class="bg-white/10 text-white">
                    <th class="text-center px-3 py-2 border border-white/10">
                      POS
                    </th>
                    <th class="text-left px-3 py-2 border border-white/10">
                      Equipo
                    </th>
                    <th class="text-center px-3 py-2 border border-white/10">
                      PJ
                    </th>
                    <th class="text-center px-3 py-2 border border-white/10">
                      PG
                    </th>
                    <th class="text-center px-3 py-2 border border-white/10">
                      PP
                    </th>
                    <th class="text-center px-3 py-2 border border-white/10">
                      GF
                    </th>
                    <th class="text-center px-3 py-2 border border-white/10">
                      GC
                    </th>
                    <th class="text-center px-3 py-2 border border-white/10">
                      DG
                    </th>
                    <th class="text-center px-3 py-2 border border-white/10 font-bold">
                      PTS
                    </th>
                  </tr>
                </thead>

                <tbody>
                  {equipos.map((team, i) => (
                    <tr class={i < 2 ? "bg-green-500/20" : "bg-red-500/20"}>
                      <td class="px-3 py-2 border border-white/10 text-center font-bold">
                        {i === 0 ? "ðŸ¥‡" : i === 1 ? "ðŸ¥ˆ" : i + 1}
                      </td>
                      <td class="px-3 py-2 border border-white/10 text-left">
                        {team.equipo}
                      </td>
                      <td class="px-3 py-2 border border-white/10 text-center">
                        {team.PJ}
                      </td>
                      <td class="px-3 py-2 border border-white/10 text-center" data-group={grupo} data-index={i} data-key="PG">
                        {team.PG}
                      </td>
                      <td class="px-3 py-2 border border-white/10 text-center" data-group={grupo} data-index={i} data-key="PP">
                        {team.PP}
                      </td>
                      <td class="px-3 py-2 border border-white/10 text-center" data-group={grupo} data-index={i} data-key="GF">
                        {team.GF}
                      </td>
                      <td class="px-3 py-2 border border-white/10 text-center" data-group={grupo} data-index={i} data-key="GC">
                        {team.GC}
                      </td>
                      <td class="px-3 py-2 border border-white/10 text-center">
                        {team.DG}
                      </td>
                      <td class="px-3 py-2 border border-white/10 text-center" data-group={grupo} data-index={i} data-key="PUNTOS">
                        {team.PUNTOS}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        ))
      }
    </div>

    {isAdmin && (
      <div class="mt-[600px]">
        <h2 class="text-xl font-bold text-white mb-2">Editor JSON (solo admin)</h2>
        <textarea id="json-editor" class="w-full h-48 bg-zinc-900 text-white p-2 rounded"></textarea>
        <div class="mt-2">
          <button id="save-btn" class="px-4 py-2 bg-emerald-500 text-white rounded hover:bg-emerald-600">Guardar</button>
          <span id="save-status" class="ml-4 text-sm text-white"></span>
        </div>
        <p class="mt-1 text-xs text-gray-300">Haz clic en una celda de la tabla para editarla interactivamente.</p>
      </div>
    )}
  </section>

  {isAdmin && (
    <script type="module" define:vars={{ tablaData }}>
      // admin editing helpers

      function updateTextarea() {
        const ta = document.getElementById('json-editor');
        if (ta) ta.value = JSON.stringify(tablaData, null, 2);
      }
      updateTextarea();

      document.querySelectorAll('td[data-key]').forEach(cell => {
        cell.style.cursor = 'pointer';
        cell.addEventListener('click', () => {
          const g = cell.dataset.group;
          const idx = parseInt(cell.dataset.index, 10);
          const key = cell.dataset.key;
          const old = cell.textContent || '';
          const newVal = prompt(`Nuevo valor para ${key} en ${tablaData[g][idx].equipo} (actual: ${old})`, old);
          if (newVal !== null) {
            const numeric = Number(newVal);
            tablaData[g][idx][key] = isNaN(numeric) ? newVal : numeric;
            cell.textContent = tablaData[g][idx][key];
            updateTextarea();
          }
        });
      });

      document.getElementById('save-btn').addEventListener('click', async () => {
        const statusEl = document.getElementById('save-status');
        if (statusEl) statusEl.textContent = 'guardando...';
        // try to parse textarea in case admin edited raw JSON
        let payload = tablaData;
        const ta = document.getElementById('json-editor');
        if (ta) {
          try {
            payload = JSON.parse(ta.value);
            // also update internal object for further edits
            Object.assign(tablaData, payload);
          } catch (err) {
            if (statusEl) statusEl.textContent = 'JSON invÃ¡lido';
            return;
          }
        }
        try {
          const res = await fetch('/api/tabla-posiciones', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (res.ok) {
            if (statusEl) {
              statusEl.textContent = 'guardado';
              setTimeout(() => { if (statusEl) statusEl.textContent = ''; }, 2000);
            }
            // refresh to apply sorting based on new data
            setTimeout(() => { location.reload(); }, 500);
          } else {
            if (statusEl) statusEl.textContent = 'error';
          }
        } catch (e) {
          console.error(e);
          if (statusEl) statusEl.textContent = 'error';
        }
      });
    </script>
  )}

</Layout>      