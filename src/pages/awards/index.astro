---
export const prerender = false;
import LastEditionWinners from "@/components/LastEditionWinners.astro";
import Layout from "@/layouts/Layout.astro";
import { AWARDS_VOTES_RESULT } from "@/data/awards-winners";
import { IS_VOTES_OPEN, EVENT_TIMESTAMP, LAST_EDITION_VOD_URL } from "@/config";
import LaunchCountdown from "@/components/LaunchCountdown";
import TwitchEmbed from "@/components/TwitchEmbed.astro";
import {
  LucideTrophy,
  LucideVote,
  LucideHistory,
  LucideCalendarClock,
  LucideSparkles,
  LucidePlay,
  LucideRadio,
  LucideTwitch,
} from "lucide-preact";
import { getTotalVotes } from "@/utils/awards-vote-system";
import { MdiTwitch } from "@/icons/MdiTwitch";

const votesOpen = IS_VOTES_OPEN();
const totalVotes = await getTotalVotes();

// --- LÓGICA DE TIEMPO Y ESTADOS ---
const now = Date.now();
const EVENT_DURATION_MS = 4 * 60 * 60 * 1000; // 4 Horas aprox
const eventEndTime = EVENT_TIMESTAMP + EVENT_DURATION_MS;

// Estados temporales
const isPreEvent = now < EVENT_TIMESTAMP;
const isLive = now >= EVENT_TIMESTAMP && now < eventEndTime;
const isFinished = now >= eventEndTime;

// Lógica de visualización de video
// Asumimos que si hay URL, queremos mostrar el player (ya sea en vivo o repetición)
const hasVodUrl = !!LAST_EDITION_VOD_URL;
const showPlayer = (isLive || isFinished) && hasVodUrl;

// Lógica de visualización del Countdown:
// SOLO si es pre-evento.
const showCountdown = isPreEvent;

// Helper para extraer ID de Twitch
// Soporta formatos: https://www.twitch.tv/videos/232085233
const getTwitchVideoId = (url?: string) => {
  try {
    const match = url?.match(/\/videos\/(\d+)/);
    return match ? match[1] : null;
  } catch (e) {
    return null;
  }
};

const vodId = getTwitchVideoId(LAST_EDITION_VOD_URL);

// IMPORTANTE: Para que Twitch funcione, debes especificar el dominio padre.
// He agregado localhost y 127.0.0.1 para desarrollo.
// Cambia 'tudominio.com' por el dominio real de producción.
const TWITCH_PARENTS =
  "&parent=localhost&parent=127.0.0.1&parent=saltouruguay.com";

// Helper para tarjetas glass
const cardClass =
  "relative overflow-hidden rounded-3xl border border-white/10 bg-black/40 backdrop-blur-md p-8 shadow-2xl transition-all hover:border-yellow-500/30";
---

<Layout title="SaltoAwards">
  <div class="fixed inset-0 -z-10 bg-[#050505]">
    <div
      id="backdrop-awards"
      class="absolute inset-0 bg-center bg-cover opacity-40"
    >
    </div>
    <div
      class="absolute inset-0 bg-gradient-to-t from-[#050505] via-[#050505]/80 to-transparent"
    >
    </div>
    <div
      class="absolute top-0 left-1/2 -translate-x-1/2 w-full max-w-4xl h-[500px] bg-yellow-500/10 blur-[120px] rounded-full pointer-events-none"
    >
    </div>
  </div>

  <div class="flex flex-col max-w-6xl mx-auto min-h-screen pt-24 px-4 pb-20">
    {/* --- HERO SECTION --- */}
    <header
      class="flex flex-col items-center justify-center text-center mb-16 relative z-10"
    >
      <div class="relative group cursor-default">
        <div
          class="absolute inset-0 bg-yellow-500/20 blur-2xl rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-700"
        >
        </div>
        <img
          src="/images/trofeo-awards.webp"
          alt="SaltoAwards Trofeo"
          class="relative h-32 saturate-125 md:h-40 w-auto object-contain drop-shadow-[0_0_15px_rgba(255,255,255,0.1)] transition-transform duration-500 hover:scale-105"
        />
      </div>

      <div class="mt-8 space-y-2">
        {/* Badge de Estado del Evento */}
        {
          isLive ? (
            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-red-500/50 bg-red-500/20 text-red-400 text-xs font-bold uppercase tracking-widest backdrop-blur-md mb-2 animate-pulse">
              <LucideRadio size={14} />
              <span>En Vivo Ahora</span>
            </div>
          ) : (
            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-yellow-500/30 bg-yellow-500/10 text-yellow-400 text-xs font-bold uppercase tracking-widest backdrop-blur-md mb-2">
              <LucideSparkles size={14} />
              <span> Evento especial </span>
            </div>
          )
        }

        <h1
          class="text-6xl md:text-8xl font-anton text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 via-yellow-500 to-yellow-700 drop-shadow-sm tracking-tight uppercase"
        >
          SaltoAwards
        </h1>
        <h2
          class="text-xl md:text-2xl font-rubik text-white/80 max-w-2xl mx-auto font-light"
        >
          Celebrando lo mejor de nuestra comunidad
        </h2>
      </div>
    </header>

    {/* --- MAIN GRID --- */}
    <main class="w-full">
      {
        votesOpen ? (
          /* --- ESTADO 1: VOTACIÓN ABIERTA --- */
          <div class="space-y-16">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {/* Tarjeta Principal de Votación (Ocupa 2 columnas) */}
              <section
                class={`${cardClass} md:col-span-2 lg:col-span-2 flex flex-col justify-center items-start text-left group border-yellow-500/50 bg-gradient-to-br from-yellow-900/20 to-black`}
              >
                <div class="absolute right-0 top-0 p-12 opacity-10 group-hover:opacity-20 transition-opacity">
                  <LucideVote size={200} />
                </div>

                <div class="relative z-10">
                  <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-yellow-500/20 border border-yellow-500/30 text-yellow-300 text-xs font-bold uppercase tracking-widest mb-6">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75" />
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-yellow-500" />
                    </span>
                    {totalVotes.toLocaleString()} Votos registrados
                  </div>
                  <h2 class="text-4xl md:text-5xl font-anton text-white uppercase mb-4">
                    ¡La votación{" "}
                    <span class="text-yellow-400">está abierta!</span>
                  </h2>
                  <p class="text-lg text-gray-300 mb-8 max-w-md">
                    Es tu momento de decidir. Elige a tus favoritos y haz que su
                    esfuerzo sea reconocido.
                  </p>
                  <a
                    href="/awards/vota"
                    class="inline-flex items-center gap-3 px-8 py-4 bg-yellow-500 hover:bg-yellow-400 text-black font-bold text-xl uppercase rounded-xl transition-all hover:scale-105 hover:shadow-[0_0_30px_rgba(234,179,8,0.4)]"
                  >
                    <LucideVote /> Ir a Votar
                  </a>
                </div>
              </section>

              {/* Tarjeta Informativa Lateral */}
              <section
                class={`${cardClass} flex flex-col justify-center items-center text-center`}
              >
                <div class="p-4 rounded-full bg-white/5 mb-4 text-yellow-400">
                  <LucideHistory size={32} />
                </div>
                <h3 class="text-2xl font-anton text-white uppercase mb-2">
                  El Legado
                </h3>
                <p class="text-white/60 text-sm mb-6">
                  Repasa la historia de los premios antes de emitir tu voto.
                </p>
                <a
                  href="#history"
                  class="text-yellow-400 hover:text-white underline underline-offset-4 decoration-yellow-500/50 hover:decoration-white transition-all"
                >
                  Ver ganadores anteriores
                </a>
              </section>
            </div>
            {/* Historial (Se renderiza igual abajo, pero está aquí para mantener estructura) */}
            <section id="history" class="scroll-mt-24">
              <div class="flex items-center gap-4 mb-8">
                <div class="h-px flex-1 bg-white/10" />
                <h3 class="text-2xl font-anton uppercase text-white tracking-wider flex items-center gap-2">
                  <LucideHistory class="text-yellow-500" /> Historial de
                  Ediciones
                </h3>
                <div class="h-px flex-1 bg-white/10" />
              </div>

              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                {Object.keys(AWARDS_VOTES_RESULT)
                  .sort((a, b) => Number(a) - Number(b))
                  .map((y) => {
                    const year = Number(y);
                    return (
                      <a
                        href={`/awards/${year}`}
                        class={`${cardClass} group !p-6 flex flex-col items-center justify-center hover:bg-white/5 transition-all duration-300`}
                      >
                        <span class="text-5xl font-anton text-white group-hover:text-yellow-400 transition-colors mb-2">
                          {year}
                        </span>
                        <span class="text-xs uppercase tracking-widest text-white/40 group-hover:text-yellow-500/60">
                          Ver Ganadores
                        </span>
                      </a>
                    );
                  })}
              </div>
            </section>
          </div>
        ) : (
          /* --- ESTADO 2: VOTACIÓN CERRADA (EVENTO / COUNTDOWN / FINALIZADO) --- */
          <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            {/* 1. SECCIÓN DINÁMICA: STREAM/VOD o COUNTDOWN */}
            <section
              class={`${cardClass} lg:col-span-12 flex flex-col items-center justify-center text-center !py-12 !px-2 ${
                showPlayer ? "border-yellow-500/40 shadow-[0_0_50px_rgba(234,179,8,0.15)]" : ""
              }`}
            >
              {showPlayer ? (
                /* --- A. CASO: HAY VIDEO (EN VIVO O REPETICIÓN) --- */
                <div class="w-full max-w-5xl mx-auto animate-in fade-in zoom-in duration-700">
                  <div class="mb-6 flex items-center justify-center gap-3 text-[#9146FF]">
                     {isLive ? <LucideRadio class="animate-pulse" /> : <MdiTwitch />}
                     <span class="font-bold tracking-widest uppercase text-sm text-yellow-500">
                        {isLive ? "Transmitiendo en Directo" : "Revive la Gala"}
                     </span>
                  </div>
                  
                  {/* Contenedor con efecto Glow */}
                  <div class="relative w-full rounded-2xl p-[1px] bg-gradient-to-b from-yellow-500/50 to-transparent shadow-2xl group">
                     {/* Glow difuso detrás */}
                     <div class="absolute -inset-1 bg-gradient-to-r from-[#9146FF] to-yellow-500 opacity-20 blur-lg group-hover:opacity-30 transition-opacity duration-500"></div>
                     
                     <div class="relative z-10 rounded-2xl overflow-hidden bg-black">
                       <TwitchEmbed 
                          videoId={vodId!} 
                          // Si estuviera en vivo y NO usáramos videoId, pondrías: 
                          // username="saltouruguay" channelId="12345"
                          placeholder="/images/awards-cover-placeholder.webp" 
                          autoLoad={isLive}
                       />
                     </div>
                  </div>
                </div>

              ) : showCountdown ? (
                /* --- B. COUNTDOWN (Solo si es Futuro) --- */
                <>
                  <div class="mb-6 flex items-center gap-3 text-yellow-500/80">
                    <LucideCalendarClock size={24} />
                    <span class="font-bold tracking-widest uppercase text-sm">
                      Próxima Edición
                    </span>
                  </div>

                  <h3 class="text-3xl md:text-4xl font-rubik font-bold text-white mb-8 max-w-3xl">
                    Prepárate para los{" "}
                    <span class="text-yellow-500">#SaltoAwards2025</span>
                  </h3>

                  <div class="w-full max-w-4xl scale-90 md:scale-100">
                    <LaunchCountdown
                      timestamp={EVENT_TIMESTAMP}
                      showCalendarButton={true}
                      classNames={{
                        container: "justify-center gap-4 md:gap-8",
                        block:
                          "bg-black/50 border border-white/10 rounded-xl p-4 md:p-6 min-w-[80px] md:min-w-[120px]",
                        timeDisplay:
                          "text-4xl md:text-6xl font-anton text-yellow-400",
                        label:
                          "text-xs md:text-sm font-rubik text-white/50 uppercase tracking-widest mt-2",
                      }}
                      client:idle
                    />
                  </div>
                </>
              ) : (
                /* --- C. FALLBACK (Finalizado sin video) --- */
                <div class="py-8 animate-in fade-in slide-in-from-bottom-4 duration-700">
                  <div class="mb-6 inline-flex p-4 rounded-full bg-yellow-500/10 text-yellow-500 border border-yellow-500/20">
                    <LucideSparkles size={32} />
                  </div>
                  <h3 class="text-4xl md:text-5xl font-anton text-white uppercase mb-4">
                    Edición <span class="text-yellow-500">Finalizada</span>
                  </h3>
                  <p class="text-xl text-white/60 max-w-2xl mx-auto">
                    ¡Gracias a todos por participar en los SaltoAwards! <br />
                    Pronto subiremos la repetición del evento.
                  </p>
                </div>
              )}
            </section>

            {/* 2. Last Winners (Main Content Area) */}
            <section class="lg:col-span-8 space-y-6">
              <div class="flex items-center gap-4 mb-4">
                <div class="h-px flex-1 bg-white/10" />
                <h3 class="text-xl font-anton uppercase text-white tracking-wider flex items-center gap-2">
                  <LucideTrophy class="text-yellow-500" /> Campeones Vigentes
                </h3>
                <div class="h-px flex-1 bg-white/10" />
              </div>

              {/* Wrapper para el componente existente */}
              <div class="bg-white/5 border border-white/10 rounded-3xl p-6 md:p-8">
                <LastEditionWinners />
              </div>
            </section>

            {/* 3. Archive / History (Sidebar) */}
            <aside id="history" class="lg:col-span-4 space-y-6">
              <div class={`${cardClass} h-full`}>
                <h3 class="text-2xl font-anton text-white uppercase mb-6 flex items-center gap-2">
                  <LucideHistory class="text-white/50" /> Historial
                </h3>

                <div class="grid grid-cols-2 gap-3">
                  {Object.keys(AWARDS_VOTES_RESULT)
                    .sort((a, b) => Number(a) - Number(b))
                    .map((y) => {
                      const year = Number(y);
                      return (
                        <a
                          href={`/awards/${year}`}
                          class="group relative flex flex-col items-center justify-center py-6 px-4 bg-white/5 hover:bg-yellow-500/10 border border-white/10 hover:border-yellow-500/50 rounded-xl transition-all duration-300"
                        >
                          <span class="text-2xl font-anton text-white group-hover:text-yellow-400 transition-colors">
                            {year}
                          </span>
                          <span class="text-[10px] uppercase tracking-widest text-white/40 group-hover:text-yellow-500/60 mt-1">
                            Ver Ganadores
                          </span>
                        </a>
                      );
                    })}
                </div>

                <div class="mt-8 pt-8 border-t border-white/10 text-center">
                  <p class="text-sm text-white/40 italic">
                    "La historia la escriben los que se atreven a saltar."
                  </p>
                </div>
              </div>
            </aside>
          </div>
        )
      }
    </main>
  </div>

  <style>
    #backdrop-awards {
      background-image: url("/images/awards-fondo.webp");
    }
  </style>

  <script>
    import { $ } from "@/lib/dom-selector";
    import { showSignInDialog } from "@/lib/utils";

    document.addEventListener("astro:page-load", () => {
      const $viewNominees = $("div[data-login-on-click]");
      if ($viewNominees) {
        $viewNominees.addEventListener("click", (e) => {
          showSignInDialog();
        });
      }
    });
  </script>
</Layout>
