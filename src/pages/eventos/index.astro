---
import PageBreadcrumb from "@/components/PageBreadcrumb.astro";
import Twitch from "@/icons/Twitch.astro";
import Layout from "@/layouts/Layout.astro";
import { getPaginatedEvents } from "@/lib/events";
import { LucideCalendar, LucideClock, LucideUsers } from "lucide-preact";
import { DateTime } from "luxon";

const { events } = await getPaginatedEvents(1, 10);
const firstFeaturedEvent = events.find((event) => event.featured);

const getTimeStatus = (startDate: Date, endDate: Date) => {
  const now = DateTime.local(); // Hora local de la zona horaria actual
  const start = DateTime.fromJSDate(new Date(startDate)).setZone(
    "America/Montevideo"
  ); // Cambia "America/Montevideo" por la zona horaria que necesites
  const end = DateTime.fromJSDate(new Date(endDate)).setZone(
    "America/Montevideo"
  );

  const hoursUntilStart = Math.ceil(start.diff(now, "hours").hours);
  const hoursUntilEnd = Math.ceil(end.diff(now, "hours").hours);

  if (now < start) {
    return { text: `Faltan ${hoursUntilStart} horas`, status: 0 };
  }

  if (now > end) {
    return {
      text: `Finalizado hace ${Math.abs(hoursUntilEnd)} horas`,
      status: 2,
    };
  }

  return {
    text: `En curso desde hace ${Math.abs(hoursUntilEnd)} horas`,
    status: 1,
  };
};
---

<Layout
  title="Eventos"
  description="Participa en nuestros eventos exclusivos y conéctate con la comunidad"
>
  <div class="flex flex-col max-w-7xl mx-auto min-h-screen mt-16">
    <header class="mb-8">
      <PageBreadcrumb
        breadcrumbs={[{ text: "Eventos", href: "/eventos" }]}
        pathname="/eventos"
      />
      <h1 class="text-3xl font-rubik font-medium tracking-tight">
        Eventos de la Comunidad
      </h1>
      <p class="text-neutral-500 mt-1">
        Participa en nuestros eventos exclusivos y conéctate con la comunidad
      </p>
    </header>

    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
      {
        firstFeaturedEvent && (
          <div class="rounded-lg border text-card-foreground shadow-sm col-span-full border-white/50 bg-neutral-500/5">
            <div class="flex flex-col space-y-1.5 p-6 pb-4">
              <div class="flex justify-between items-start">
                <div class="space-y-1">
                  <div class="flex items-center gap-2">
                    <div class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-primary text-primary-foreground">
                      Destacado
                    </div>
                    {getTimeStatus(
                      firstFeaturedEvent.startDate,
                      firstFeaturedEvent.endDate
                    ).status === 0 ? (
                      <div class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-blue-500/10 text-blue-500">
                        Próximo
                      </div>
                    ) : getTimeStatus(
                        firstFeaturedEvent.startDate,
                        firstFeaturedEvent.endDate
                      ).status === 1 ? (
                      <div class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-yellow-500/10 text-yellow-500">
                        En curso
                      </div>
                    ) : (
                      <div class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-red-500/10 text-red-500">
                        Finalizado
                      </div>
                    )}

                    <div class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-purple-500/10 text-purple-500">
                      Stream especial
                    </div>
                  </div>
                  <h2 class="text-2xl font-semibold">
                    {firstFeaturedEvent.name}
                  </h2>
                </div>
                <div class="flex flex-col items-end">
                  <div class="flex items-center gap-1 text-sm text-muted-foreground">
                    <LucideUsers class="h-4 w-4" />
                    <span>
                      {firstFeaturedEvent.assistants.length} confirmados
                    </span>
                  </div>
                  <div class="flex items-center gap-1 text-sm text-muted-foreground mt-1">
                    <LucideCalendar class="h-4 w-4" />
                    <span>
                      {new Date(
                        firstFeaturedEvent.startDate
                      ).toLocaleDateString("es-ES", {
                        year: "numeric",
                        month: "long",
                        day: "numeric",
                      })}
                      {", "}
                      {new Date(
                        firstFeaturedEvent.startDate
                      ).toLocaleTimeString("es-ES", {
                        hour: "2-digit",
                        minute: "2-digit",
                      })}
                    </span>
                  </div>
                </div>
              </div>
              <div class="flex items-start gap-4 mt-4">
                <img
                  src={firstFeaturedEvent.cover}
                  alt={`Portada de ${firstFeaturedEvent.name}`}
                  width={240}
                  height={140}
                  class="rounded-md object-cover"
                />
                <div class="flex-1">
                  <p class="text-sm">{firstFeaturedEvent.description}</p>
                  <div class="mt-4 space-y-2">
                    <div class="flex items-center justify-between text-sm">
                      <span class="text-muted-foreground">Organizado por:</span>
                      <span class="font-medium">
                        {firstFeaturedEvent.mainOrganizer.displayName}
                      </span>
                    </div>
                    {firstFeaturedEvent.platform && (
                      <div class="flex items-center justify-between text-sm">
                        <span class="text-muted-foreground">Plataforma:</span>
                        <span class="font-medium flex items-center gap-1">
                          <Twitch class="h-4 w-4 text-purple-500" />
                          Twitch
                        </span>
                      </div>
                    )}
                    <div class="flex items-center justify-between text-sm">
                      <span class="text-muted-foreground">Participación:</span>
                      <span class="font-medium">Abierta a todos</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="flex justify-between items-center mt-4">
                <div
                  class={`flex items-center gap-1 text-sm ${getTimeStatus(firstFeaturedEvent.startDate, firstFeaturedEvent.endDate).status === 0 ? "text-green-500" : getTimeStatus(firstFeaturedEvent.startDate, firstFeaturedEvent.endDate).status === 1 ? "text-yellow-500" : "text-red-500"}`}
                >
                  <LucideClock class="h-4 w-4" />
                  <span>
                    {new Date(firstFeaturedEvent.startDate) > new Date()
                      ? "Próximo, "
                      : "Finalizado, "}
                    {
                      getTimeStatus(
                        firstFeaturedEvent.startDate,
                        firstFeaturedEvent.endDate
                      ).text
                    }
                  </span>
                </div>

                {firstFeaturedEvent.url && (
                  <button class="inline-flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium text-white bg-green-600 hover:bg-green-700">
                    <a
                      href={firstFeaturedEvent.url}
                      target="_blank"
                      rel="noopener noreferrer"
                    >
                      Unirme al stream
                    </a>
                  </button>
                )}
              </div>
            </div>
          </div>
        )
      }
    </div>
  </div>
</Layout>
