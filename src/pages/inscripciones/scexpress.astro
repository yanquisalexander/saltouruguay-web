---
import Discord from "@/icons/Discord.astro";
import Layout from "@/layouts/Layout.astro";
import { getDiscordUser } from "@/services/discord";
import { getSession } from "auth-astro/server";
import { LucideX } from "lucide-preact";
import { markdown } from "@astropub/md";
import { SaltoCraftExtremo3InscriptionsTable } from "@/db/schema";
import { client } from "@/db/client";
import { eq } from "drizzle-orm";

const inscripcionTOS = `
### 1) Modificaciones por parte de la Organización
LA ORGANIZACIÓN se reserva el derecho de alterar o modificar la información de la serie de Minecraft, incluyendo los presentes términos y condiciones, comprometiéndose a notificar oportunamente a los participantes.

### 2) Derecho de admisión
LA ORGANIZACIÓN se reserva el derecho de admitir o rechazar solicitudes de participación en la serie.

### 3) Derechos de propiedad intelectual
EL PARTICIPANTE reconoce y acepta que LA ORGANIZACIÓN es titular de los derechos de propiedad intelectual y de imagen asociados al proyecto de la serie de Minecraft, incluyendo la marca y la identidad gráfica. Los contenidos generados por los participantes (como transmisiones, videos o clips) les pertenecen a ellos, siempre que no infrinjan derechos de terceros ni afecten la imagen de la serie.

### 4) Transmisión y difusión
Los participantes tienen libertad para grabar o transmitir en vivo su experiencia en la serie de Minecraft a través de sus propios canales y plataformas. LA ORGANIZACIÓN podrá establecer lineamientos generales, como la inclusión de un logo, leyenda o marca de agua, con fines de promoción y visibilidad de la serie.

### 5) Premios y reconocimientos
En caso de que existan premios, reconocimientos o beneficios vinculados a la participación, serán detallados por LA ORGANIZACIÓN y estarán sujetos a los presentes términos y condiciones. LA ORGANIZACIÓN se reserva el derecho de modificar las reglas de asignación en caso de fuerza mayor o circunstancias imprevistas, notificándolo oportunamente.

---

En caso de cualquier consulta o duda, favor de comunicarse con el equipo de organización.
`.trim();

const session = await getSession(Astro.request);

const HAS_DISCORD_LINKED = !!session?.user.discordId;

const discordInfo = await getDiscordUser(
  session?.user.discordId as string
).catch((error) => {
  console.error("Error getting Discord user", error);
  return null;
});

const IS_USER_INSCRIBED = await client
  .select()
  .from(SaltoCraftExtremo3InscriptionsTable)
  .where(eq(SaltoCraftExtremo3InscriptionsTable.userId, session?.user?.id ?? 0))
  .execute()
  .then((inscriptions) => {
    return inscriptions.length > 0;
  });
---

<Layout
  title="Inscripción SaltoCraft Extremo Express"
  description="Inscripción para el evento SaltoCraft Extremo Express"
>
  <div class="flex flex-col max-w-5xl mx-auto min-h-screen mt-16">
    <header class="flex flex-col items-center justify-center space-y-4 mb-16">
      <img
        src="/images/scexpress.webp"
        alt="Logo SaltoCraft Extremo Express"
        class="h-28 lg:h-32"
      />

      <h1
        class="with-glyph flex relative w-max text-3xl transform px-2 animate-fade-in-up animate-delay-150 font-minecraftia tracking-wider font-bold text-[#FF4444] mix-blend-screen !skew-x-[-20deg] -rotate-6"
      >
        <span class="flex !skew-x-[20deg] transform"> Inscripción </span>
      </h1>
    </header>
    {
      !session ? (
        <div class="flex flex-col items-center justify-center space-y-4">
          <p class="text-center italic font-rubik">
            Debes iniciar sesión para poder inscribirte.
          </p>
          <button
            id="login"
            class="px-4 py-2 bg-[#FF4444] text-white rounded-md hover:bg-[#e63939] transition-colors"
          >
            Iniciar sesión
          </button>
        </div>
      ) : (
        <div class="flex flex-col items-center justify-center space-y-4">
          <div class="flex flex-col items-center gap-2">
            <article class="flex items-center gap-2">
              <img
                src={session?.user.image}
                alt={`Avatar de ${session?.user.name}`}
                class="size-12 p-0.5 rounded-full border-[3px] border-[#FF4444] border-dashed"
              />
              <span class="font-anton font-light text-xl">
                {session?.user.name}
              </span>
            </article>
            <button
              id="logout"
              class="text-[#FF4444] hover:underline cursor-pointer"
            >
              ¿No eres tú? Cerrar sesión
            </button>
          </div>
          {IS_USER_INSCRIBED ? (
            <div class="flex flex-col items-center">
              <span class="text-center">
                ¡Ya estás inscrito en SaltoCraft Extremo Express!
              </span>
              <span class="text-center">
                Pronto te contactaremos para más información.
              </span>
            </div>
          ) : (
            <p class="text-center">
              {HAS_DISCORD_LINKED ? (
                <div class="flex flex-col items-center gap-2">
                  <div
                    class="hidden"
                    data-discord-username={discordInfo?.username}
                  />
                  <span class="text-center">
                    ¡Ya tienes tu cuenta de Discord{" "}
                    <strong>
                      {discordInfo?.username}#{discordInfo?.discriminator}
                    </strong>{" "}
                    vinculada!
                    <br />
                    Ahora puedes inscribirte en SaltoCraft Extremo Express.
                  </span>
                  <button
                    id="inscribirse"
                    class="px-4 py-2 bg-[#FF4444] text-white rounded-md"
                  >
                    Inscribirse
                  </button>

                  <div class="flex flex-col mt-4 gap-2 mask bg-[#FF4444] w-full">
                    <span class="text-center font-anton text-lg text-black">
                      A tener en cuenta
                    </span>
                    <p class="text-center max-w-96 px-8 pb-8 text-black">
                      Para participar necesitas tener{" "}
                      <strong>Minecraft Java Edition</strong> y{" "}
                      <strong>Discord</strong> para mantenerte informado sobre
                      cualquier cambio o novedad.
                    </p>
                  </div>
                </div>
              ) : (
                <div class="flex flex-col items-center text-center gap-2">
                  <span>
                    Debes vincular tu cuenta de Discord para poder inscribirte.
                  </span>
                  <button
                    id="link-discord"
                    class="px-4 py-2 bg-[#FF4444] text-white rounded-md"
                  >
                    <Discord class="size-6 inline-block mr-2" />
                    Vincular Discord
                  </button>
                </div>
              )}
            </p>
          )}
        </div>
      )
    }
  </div>

  <!-- Modal de inscripción -->
  <dialog
    id="inscripcion-modal"
    class="max-w-[640px] w-full fixed inset-0 z-[99999999] p-8 pt-20 animate-fade-in-up bg-[#0b1422] border border-line rounded-xl shadow-2xl text-white"
  >
    <form id="inscripcion-modal-close" class="absolute top-5 right-5">
      <button type="button" class="text-white">
        <LucideX class="w-6 h-6" />
      </button>
    </form>

    <div class="flex flex-col items-center space-y-4">
      <img src="/favicon.svg" class="aspect-square size-24" />
      <h2 class="text-2xl font-bold text-center">
        Inscripción SaltoCraft Extremo Express
      </h2>
    </div>

    <div class="flex flex-col space-y-4 mt-8">
      <form id="inscription-form" class="space-y-6">
        <!-- Instagram -->
        <div class="flex flex-col space-y-2">
          <label for="instagram" class="font-rubik font-semibold">
            Instagram <span class="text-red-400">*</span>
          </label>
          <input
            type="text"
            id="instagram"
            name="instagram"
            placeholder="Tu nickname o link de Instagram"
            class="px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:border-[#FF4444] focus:outline-none"
            required
          />
          <small class="text-gray-400 text-sm"
            >Puede ser tu Nickname o el link que nos lleve a él</small
          >
        </div>

        <!-- Participación anterior -->
        <div class="flex flex-col space-y-2">
          <label class="font-rubik font-semibold">
            ¿Participaste de alguna edición anterior de SaltoCraft EXTREMO? <span
              class="text-red-400">*</span
            >
          </label>
          <div class="flex gap-4">
            <label class="flex items-center space-x-2 cursor-pointer">
              <input
                type="radio"
                name="participated_sc"
                value="si"
                class="text-[#FF4444]"
              />
              <span>Sí</span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
              <input
                type="radio"
                name="participated_sc"
                value="no"
                class="text-[#FF4444]"
              />
              <span>No</span>
            </label>
          </div>
        </div>

        <!-- Usuario Minecraft -->
        <div class="flex flex-col space-y-2">
          <label for="minecraft_username" class="font-rubik font-semibold">
            Usuario de Minecraft <span class="text-red-400">*</span>
          </label>
          <input
            type="text"
            id="minecraft_username"
            name="minecraft_username"
            placeholder="Tu usuario exacto de Minecraft"
            class="px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:border-[#FF4444] focus:outline-none"
            required
          />
          <small class="text-gray-400 text-sm"
            >Debe ser exacto y no necesita ser cuenta PREMIUM</small
          >
        </div>

        <!-- Equipo -->
        <div class="flex flex-col space-y-2">
          <label class="font-rubik font-semibold">
            Estado del equipo <span class="text-red-400">*</span>
          </label>
          <div class="flex flex-col gap-2">
            <label class="flex items-center space-x-2 cursor-pointer">
              <input
                type="radio"
                name="team_status"
                value="tengo"
                required
                class="text-[#FF4444]"
              />
              <span>Sí, ya tengo equipo</span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
              <input
                type="radio"
                name="team_status"
                value="buscare"
                required
                class="text-[#FF4444]"
              />
              <span>Ok, trataré de buscar</span>
            </label>
          </div>
          <small class="text-gray-400 text-sm"
            >Recuerda que se podrán ayudar al comenzar el desafío (Todos deben
            llenar el formulario)</small
          >
        </div>

        <!-- Canal de contenido -->
        <div class="flex flex-col space-y-2">
          <label for="content_channel" class="font-rubik font-semibold">
            Canal de contenido (opcional)
          </label>
          <input
            id="content_channel"
            name="content_channel"
            type="url"
            placeholder="Link a tu canal de YouTube, Twitch, etc."
            class="px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:border-[#FF4444] focus:outline-none"
          />
          <small class="text-gray-400 text-sm"
            >Si tienes un canal donde creas contenido, déjanos el link para
            promocionarte</small
          >
        </div>

        <div class="pt-4">
          <button
            type="submit"
            class="w-full py-3 bg-[#FF4444] rounded-lg text-white font-semibold transition duration-300 hover:bg-[#e63939]"
          >
            Continuar
          </button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Modal de confirmación -->
  <dialog
    id="confirmation-modal"
    class="max-w-[540px] w-full fixed inset-0 z-[99999999] p-8 pt-20 animate-fade-in-up bg-[#0b1422] border border-line rounded-xl shadow-2xl text-white"
  >
    <form id="confirmation-modal-close" class="absolute top-5 right-5">
      <button type="button" class="text-white">
        <LucideX class="w-6 h-6" />
      </button>
    </form>

    <div class="flex flex-col items-center space-y-4">
      <img src="/favicon.svg" class="aspect-square size-24" />
    </div>

    <div class="flex flex-col space-y-4 mt-8">
      <div class="prose prose-invert font-rubik text-sm">
        <h2 class="text-2xl font-bold text-center">Términos y condiciones</h2>
        <div
          class="prose prose-invert font-rubik text-sm max-h-64 overflow-y-auto"
          set:html={markdown(inscripcionTOS)}
        />
        <div
          class="bg-yellow-900/30 border border-yellow-600 rounded-lg p-4 mt-4"
        >
          <p class="text-yellow-200 text-sm mb-2">
            <strong>⚠️ Importante:</strong> Al entrar al DESAFIO SaltoCraft EXTREMO
            3 lees y aceptas las reglas aclaradas en el DISCORD OFICIAL de SaltoUruguay
            Server.
          </p>
        </div>
        <form class="flex flex-col space-y-4 mt-8" id="accept-tos-form">
          <button
            type="submit"
            class="accept w-full py-3 bg-electric-violet-500 rounded-lg text-white transition duration-300 hover:bg-electric-violet-600"
          >
            Aceptar términos e inscribirme
          </button>
        </form>
      </div>
    </div>
  </dialog>
</Layout>

<script>
  import { $ } from "@/lib/dom-selector";
  import { actions } from "astro:actions";
  import { signOut } from "auth-astro/client";
  import { toast } from "sonner";

  document.addEventListener("astro:page-load", () => {
    const $loginButton = $("#login");
    const $signInModal = $("#login-modal") as HTMLDialogElement;

    $loginButton?.addEventListener("click", () => {
      $signInModal.showModal();
    });

    const $linkDiscordButton = $("#link-discord");

    $linkDiscordButton?.addEventListener("click", () => {
      window.location.href = `/api/discord/link`;
    });

    const $logoutButton = $("#logout");

    $logoutButton?.addEventListener("click", (e) => {
      e.preventDefault();
      signOut();
    });

    const $inscribirseButton = $("#inscribirse");
    const $inscripcionModal = $("#inscripcion-modal") as HTMLDialogElement;
    const $confirmationModal = $("#confirmation-modal") as HTMLDialogElement;

    const $closeInscripcionModal = $inscripcionModal.querySelector(
      "#inscripcion-modal-close button"
    );
    const $closeConfirmationModal = $confirmationModal.querySelector(
      "#confirmation-modal-close button"
    );

    $closeInscripcionModal?.addEventListener("click", () => {
      $inscripcionModal.close();
    });

    $closeConfirmationModal?.addEventListener("click", () => {
      $confirmationModal.close();
    });

    $inscribirseButton?.addEventListener("click", () => {
      $inscripcionModal.showModal();
    });

    // Form data storage
    let formData = {};

    const $inscriptionForm = $("#inscription-form");

    $inscriptionForm?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formDataObj = new FormData(e.target as HTMLFormElement);
      formData = Object.fromEntries(formDataObj.entries());

      $inscripcionModal.close();
      $confirmationModal.showModal();
    });

    const $acceptTOSForm = $("#accept-tos-form");

    $acceptTOSForm?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const $discordUsername = $("[data-discord-username]");

      if (!$discordUsername || !$discordUsername.dataset.discordUsername) {
        toast.error("No hemos podido obtener tu nombre de usuario de Discord.");
        return;
      }

      // @ts-ignore
      const { error } = await actions.inscribeToSaltoCraftExtremo3({
        discordUsername: $discordUsername.dataset.discordUsername,
        acceptedTerms: true,
        ...formData,
      });

      if (error) {
        toast.error(
          typeof error === "string"
            ? error
            : error.message || JSON.stringify(error)
        );
        return;
      }

      toast.success("¡Te has inscrito correctamente a SaltoCraft Extremo 3!");
      $confirmationModal.close();
      window.location.reload();
    });
  });
</script>

<style>
  h1.with-glyph:after {
    content: "a";
    @apply text-[80px] font-atomic-extras mt-10 absolute inset-x-0 text-center;
    z-index: -1;
  }

  .mask {
    -webkit-mask-composite: source-in;
    mask-image: url(/images/mask.webp);
    mask-position: 50%;
    mask-size: cover;
    mask-repeat: no-repeat;
    mask-clip: content-box;
    mask-origin: content-box;
    mask-composite: source-in;
    mask-mode: alpha;
  }

  @font-face {
    font-family: "Minecraftia";
    src: url("/fonts/Minecraftia.woff2") format("woff2");
  }
</style>
