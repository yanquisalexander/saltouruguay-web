---
import Discord from "@/icons/Discord.astro";
import Layout from "@/layouts/Layout.astro";
import { getDiscordUser } from "@/services/discord";
import { getSession } from "auth-astro/server";
import { LucideX } from "lucide-preact";
import { markdown } from "@astropub/md";
import { SaltoCraftExtremo3InscriptionsTable } from "@/db/schema";
import { client } from "@/db/client";
import { eq } from "drizzle-orm";

const inscripcionTOS = `
### 1) Modificaciones por parte de la Organización
LA ORGANIZACIÓN se reserva el derecho de alterar o modificar la información de la serie de Minecraft, incluyendo los presentes términos y condiciones, comprometiéndose a notificar oportunamente a los participantes.

### 2) Derecho de admisión
LA ORGANIZACIÓN se reserva el derecho de admitir o rechazar solicitudes de participación en la serie.

### 3) Derechos de propiedad intelectual
EL PARTICIPANTE reconoce y acepta que LA ORGANIZACIÓN es titular de los derechos de propiedad intelectual y de imagen asociados al proyecto de la serie de Minecraft, incluyendo la marca y la identidad gráfica. Los contenidos generados por los participantes (como transmisiones, videos o clips) les pertenecen a ellos, siempre que no infrinjan derechos de terceros ni afecten la imagen de la serie.

### 4) Transmisión y difusión
Los participantes tienen libertad para grabar o transmitir en vivo su experiencia en la serie de Minecraft a través de sus propios canales y plataformas. LA ORGANIZACIÓN podrá establecer lineamientos generales, como la inclusión de un logo, leyenda o marca de agua, con fines de promoción y visibilidad de la serie.

### 5) Premios y reconocimientos
En caso de que existan premios, reconocimientos o beneficios vinculados a la participación, serán detallados por LA ORGANIZACIÓN y estarán sujetos a los presentes términos y condiciones. LA ORGANIZACIÓN se reserva el derecho de modificar las reglas de asignación en caso de fuerza mayor o circunstancias imprevistas, notificándolo oportunamente.

---

En caso de cualquier consulta o duda, favor de comunicarse con el equipo de organización.
`.trim();

const session = await getSession(Astro.request);

const HAS_DISCORD_LINKED = !!session?.user.discordId;

const discordInfo = await getDiscordUser(
  session?.user.discordId as string
).catch((error) => {
  console.error("Error getting Discord user", error);
  return null;
});

const IS_USER_INSCRIBED = await client
  .select()
  .from(SaltoCraftExtremo3InscriptionsTable)
  .where(eq(SaltoCraftExtremo3InscriptionsTable.userId, session?.user?.id ?? 0))
  .execute()
  .then((inscriptions) => {
    return inscriptions.length > 0;
  });
---

<Layout
  title="Inscripción SaltoCraft Extremo Express"
  description="Inscripción para el evento SaltoCraft Extremo Express"
>
  <div class="flex flex-col max-w-5xl mx-auto min-h-screen mt-16">
    <header class="flex flex-col items-center justify-center space-y-4 mb-16">
      <img
        src="/images/scexpress.webp"
        alt="Logo SaltoCraft Extremo Express"
        class="h-28 lg:h-32"
      />

      <h1
        class="with-glyph flex relative w-max text-3xl transform px-2 animate-fade-in-up animate-delay-150 font-minecraftia tracking-wider font-bold text-[#FF4444] mix-blend-screen !skew-x-[-20deg] -rotate-6"
      >
        <span class="flex !skew-x-[20deg] transform"> Inscripción </span>
      </h1>
    </header>
    {
      !session ? (
        <div class="flex flex-col items-center justify-center space-y-4">
          <p class="text-center italic font-rubik">
            Debes iniciar sesión para poder inscribirte.
          </p>
          <button
            id="login"
            class="px-4 py-2 bg-[#FF4444] text-white rounded-md hover:bg-[#e63939] transition-colors"
          >
            Iniciar sesión
          </button>
        </div>
      ) : (
        <div class="flex flex-col items-center justify-center space-y-4">
          <div class="flex flex-col items-center gap-2">
            <article class="flex items-center gap-2">
              <img
                src={session?.user.image}
                alt={`Avatar de ${session?.user.name}`}
                class="size-12 p-0.5 rounded-full border-[3px] border-[#FF4444] border-dashed"
              />
              <span class="font-anton font-light text-xl">
                {session?.user.name}
              </span>
            </article>
            <button
              id="logout"
              class="text-[#FF4444] hover:underline cursor-pointer"
            >
              ¿No eres tú? Cerrar sesión
            </button>
          </div>
          {IS_USER_INSCRIBED ? (
            <div class="flex flex-col items-center">
              <span class="text-center">
                ¡Ya estás inscrito en SaltoCraft Extremo Express!
              </span>
              <span class="text-center">
                Pronto te contactaremos para más información.
              </span>
            </div>
          ) : (
            <p class="text-center">
              {HAS_DISCORD_LINKED ? (
                <div class="flex flex-col items-center gap-2">
                  <div
                    class="hidden"
                    data-discord-username={discordInfo?.username}
                  />
                  <span class="text-center">
                    ¡Ya tienes tu cuenta de Discord{" "}
                    <strong>
                      {discordInfo?.username}#{discordInfo?.discriminator}
                    </strong>{" "}
                    vinculada!
                    <br />
                    Ahora puedes inscribirte en SaltoCraft Extremo Express.
                  </span>
                  <button
                    id="inscribirse"
                    class="px-4 py-2 bg-[#FF4444] text-white rounded-md"
                  >
                    Inscribirse
                  </button>

                  <div class="flex flex-col mt-4 gap-2 mask bg-[#FF4444] w-full">
                    <span class="text-center font-anton text-lg text-black">
                      A tener en cuenta
                    </span>
                    <p class="text-center max-w-96 px-8 pb-8 text-black">
                      Para participar necesitas tener{" "}
                      <strong>Minecraft Java Edition</strong> y{" "}
                      <strong>Discord</strong> para mantenerte informado sobre
                      cualquier cambio o novedad.
                    </p>
                  </div>
                </div>
              ) : (
                <div class="flex flex-col items-center text-center gap-2">
                  <span>
                    Debes vincular tu cuenta de Discord para poder inscribirte.
                  </span>
                  <button
                    id="link-discord"
                    class="px-4 py-2 bg-[#FF4444] text-white rounded-md"
                  >
                    <Discord class="size-6 inline-block mr-2" />
                    Vincular Discord
                  </button>
                </div>
              )}
            </p>
          )}
        </div>
      )
    }
  </div>

  <!-- Modal de inscripción -->
  <dialog
    id="inscripcion-modal"
    class="max-w-[640px] w-full fixed inset-0 z-[99999999] p-8 pt-20 animate-fade-in-up bg-[#0b1422] border border-line rounded-xl shadow-2xl text-white"
  >
    <form id="inscripcion-modal-close" class="absolute top-5 right-5">
      <button type="button" class="text-white">
        <LucideX class="w-6 h-6" />
      </button>
    </form>

    <div class="flex flex-col items-center space-y-4">
      <img src="/favicon.svg" class="aspect-square size-24" />
      <h2 class="text-2xl font-bold text-center">
        Inscripción SaltoCraft Extremo Express
      </h2>
    </div>

    <div class="flex flex-col space-y-4 mt-8">
      <form id="inscription-form" class="space-y-6">
        <!-- Instagram -->
        <div class="flex flex-col space-y-2">
          <label for="instagram" class="font-rubik font-semibold">
            Instagram <span class="text-red-400">*</span>
          </label>
          <input
            type="text"
            id="instagram"
            name="instagram"
            placeholder="Tu nickname o link de Instagram"
            class="px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:border-[#FF4444] focus:outline-none"
            required
          />
          <small class="text-gray-400 text-sm"
            >Puede ser tu Nickname o el link que nos lleve a él</small
          >
        </div>

        <!-- Participación anterior -->
        <div class="flex flex-col space-y-2">
          <label class="font-rubik font-semibold">
            ¿Participaste de alguna edición anterior de SaltoCraft EXTREMO? <span
              class="text-red-400">*</span
            >
          </label>
          <div class="flex gap-4">
            <label class="flex items-center space-x-2 cursor-pointer">
              <input
                type="radio"
                name="participated_sc"
                value="si"
                class="text-[#FF4444]"
              />
              <span>Sí</span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
              <input
                type="radio"
                name="participated_sc"
                value="no"
                checked
                class="text-[#FF4444]"
              />
              <span>No</span>
            </label>
          </div>
        </div>

        <!-- Usuario Minecraft -->
        <div class="flex flex-col space-y-2">
          <label for="minecraft_username" class="font-rubik font-semibold">
            Usuario de Minecraft <span class="text-red-400">*</span>
          </label>
          <input
            type="text"
            id="minecraft_username"
            name="minecraft_username"
            placeholder="Tu usuario exacto de Minecraft"
            class="px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:border-[#FF4444] focus:outline-none"
            required
          />
          <small class="text-gray-400 text-sm"
            >Debe ser exacto y no necesita ser cuenta PREMIUM</small
          >
        </div>

        <!-- Equipo (oculto) -->
        <!--
        <div class="flex flex-col space-y-2">
          <label class="font-rubik font-semibold">
            Estado del equipo <span class="text-red-400">*</span>
          </label>
          <div class="flex flex-col gap-2">
            <label class="flex items-center space-x-2 cursor-pointer">
              <input
                type="radio"
                name="team_status"
                value="tengo"
                required
                class="text-[#FF4444]"
              />
              <span>Sí, ya tengo equipo</span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
              <input
                type="radio"
                name="team_status"
                value="buscare"
                required
                class="text-[#FF4444]"
              />
              <span>Ok, trataré de buscar</span>
            </label>
          </div>
          <small class="text-gray-400 text-sm"
            >Recuerda que se podrán ayudar al comenzar el desafío (Todos deben
            llenar el formulario)</small
          >
        </div>
        -->

        <!-- Canal de contenido -->
        <div class="flex flex-col space-y-2">
          <label for="content_channel" class="font-rubik font-semibold">
            Canal de contenido (opcional)
          </label>
          <input
            id="content_channel"
            name="content_channel"
            type="url"
            placeholder="Link a tu canal de YouTube, Twitch, etc."
            class="px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:border-[#FF4444] focus:outline-none"
          />
          <small class="text-gray-400 text-sm"
            >Si deseas, puedes compartir tu canal para que podamos conocerte
            mejor.</small
          >
        </div>

        <!-- Aceptación de términos -->
        <div class="flex flex-col space-y-2">
          <label class="flex items-center cursor-pointer">
            <input
              type="checkbox"
              id="accept_terms"
              class="text-[#FF4444] focus:ring-0 rounded-md"
              required
            />
            <span class="ml-2">
              Acepto los{" "}
              <a
                href="#"
                class="text-[#FF4444] underline"
                onclick="document.getElementById('terms-modal').showModal()"
                >términos y condiciones</a
              >
              .
            </span>
          </label>
        </div>

        <!-- Botón de inscripción -->
        <div>
          <button
            type="submit"
            class="w-full px-4 py-2 bg-[#FF4444] text-white rounded-md hover:bg-[#e63939] transition-colors"
          >
            Inscribirme
          </button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Modal de términos y condiciones -->
  <dialog
    id="terms-modal"
    class="max-w-[640px] w-full fixed inset-0 z-[99999998] p-8 pt-20 animate-fade-in-up bg-[#0b1422] border border-line rounded-xl shadow-2xl text-white"
  >
    <form id="terms-modal-close" class="absolute top-5 right-5">
      <button type="button" class="text-white">
        <LucideX class="w-6 h-6" />
      </button>
    </form>

    <div class="prose max-w-full">
      <h2 class="text-2xl font-bold text-center mb-4">
        Términos y condiciones
      </h2>
      <div class="flex flex-col space-y-4">
        <p>
          Estos términos y condiciones rigen la participación en la serie de
          Minecraft organizada por SaltoCraft. Al inscribirte, aceptas cumplir
          con estos términos.
        </p>

        <p>
          La serie de Minecraft es un evento comunitario donde los jugadores
          participan en desafíos y misiones en un entorno de Minecraft
          colaborativo.
        </p>

        <p>
          La ORGANIZACIÓN se reserva el derecho de modificar estos términos y
          condiciones, así como la estructura y reglas de la serie, en cualquier
          momento y sin previo aviso.
        </p>

        <p>
          La participación en la serie es gratuita, pero puede requerir la
          compra de productos o servicios relacionados con Minecraft.
        </p>

        <p>
          La ORGANIZACIÓN no se hace responsable de ningún daño, pérdida o
          inconveniente causado por la participación en la serie o por la
          imposibilidad de participar.
        </p>

        <p>
          Al inscribirte, aceptas recibir comunicaciones relacionadas con la
          serie, incluyendo pero no limitado a actualizaciones, anuncios y
          resultados.
        </p>

        <p>
          Si tienes alguna pregunta o inquietud acerca de estos términos y
          condiciones, por favor contáctanos antes de inscribirte.
        </p>
      </div>
    </div>
  </dialog>
</Layout>
