---
import { SALTO_DISCORD_GUILD_ID } from "@/config";
import { SOCIAL_NETWORKS } from "@/consts/SocialNetworks";
import { client } from "@/db/client";
import { UsersTable } from "@/db/schema";
import Layout from "@/layouts/Layout.astro";
import { getSession } from "auth-astro/server";
import { eq } from "drizzle-orm";
import {
  LucideLoader2,
  LucideAlertTriangle,
  LucideCheckCircle2,
  LucideLink,
  LucideXCircle,
} from "lucide-preact";

const DISCORD_LINK_ERRORS = {
  USER_IS_NOT_MEMBER: "USER_IS_NOT_MEMBER",
  DISCORD_ALREADY_LINKED: "DISCORD_ALREADY_LINKED",
  GENERIC: "GENERIC_ERROR",
};

// --- LOGICA DEL SERVIDOR (Misma lógica, mejor estructura de retorno) ---
async function linkDiscordAccount(request: Request) {
  const code = new URL(request.url).searchParams.get("code");
  const clientId = import.meta.env.DISCORD_CLIENT_ID;
  const clientSecret = import.meta.env.DISCORD_CLIENT_SECRET;
  const session = await getSession(request);

  if (!code || !session)
    return {
      error: true,
      code: DISCORD_LINK_ERRORS.GENERIC,
      message: "Sesión inválida",
    };

  try {
    const baseUrl = new URL(request.url).origin;
    const tokenResponse = await fetch("https://discord.com/api/oauth2/token", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({
        client_id: clientId,
        client_secret: clientSecret,
        code,
        grant_type: "authorization_code",
        redirect_uri: `${baseUrl}/api/discord/link-callback`,
      }).toString(),
    });

    if (!tokenResponse.ok)
      return {
        error: true,
        code: DISCORD_LINK_ERRORS.GENERIC,
        message: "Error de token",
      };
    const tokenData = await tokenResponse.json();

    const userResponse = await fetch("https://discord.com/api/users/@me", {
      headers: { Authorization: `Bearer ${tokenData.access_token}` },
    });
    const userData = await userResponse.json();

    const guildResponse = await fetch(
      "https://discord.com/api/users/@me/guilds",
      {
        headers: { Authorization: `Bearer ${tokenData.access_token}` },
      }
    );
    const guilds = await guildResponse.json();

    const isMember = guilds.some((g: any) => g.id === SALTO_DISCORD_GUILD_ID);
    if (!isMember)
      return { error: true, code: DISCORD_LINK_ERRORS.USER_IS_NOT_MEMBER };

    // DB Check
    const existingUser = await client
      .select({ id: UsersTable.id })
      .from(UsersTable)
      .where(eq(UsersTable.discordId, userData.id))
      .limit(1);
    if (existingUser.length > 0 && existingUser[0].id !== session.user.id) {
      return { error: true, code: DISCORD_LINK_ERRORS.DISCORD_ALREADY_LINKED };
    }

    await client
      .update(UsersTable)
      .set({ discordId: userData.id })
      .where(eq(UsersTable.id, session.user.id));
    return { success: true };
  } catch (e) {
    console.error(e);
    return {
      error: true,
      code: DISCORD_LINK_ERRORS.GENERIC,
      message: "Error interno",
    };
  }
}

const result = await linkDiscordAccount(Astro.request);
const discordUrl = SOCIAL_NETWORKS.find((n) => n.name === "Discord")?.url;
---

<Layout
  title="Vinculando Discord..."
  hideHeader
  hideFooter
  mainClassname="flex flex-col items-center justify-center min-h-dvh w-full relative overflow-hidden"
>
  {/* Fondo Ambiental */}
  <div class="fixed inset-0 -z-10 bg-[#050505]">
    <div
      class="absolute inset-0 bg-[url('/images/pattern-grid.svg')] opacity-[0.03]"
    >
    </div>
    <div
      class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[500px] h-[500px] bg-[#5865F2]/10 blur-[120px] rounded-full pointer-events-none"
    >
    </div>
  </div>

  <div class="w-full max-w-md p-4 animate-in fade-in zoom-in-95 duration-500">
    {/* CASO: ÉXITO */}
    {
      !result.error && (
        <div class="bg-[#0a0a0a] border border-green-500/20 rounded-2xl p-8 text-center shadow-2xl shadow-green-900/20">
          <div class="inline-flex p-4 bg-green-500/10 rounded-full text-green-500 mb-6 border border-green-500/20">
            <LucideCheckCircle2 size={48} />
          </div>
          <h1 class="text-2xl font-anton text-white uppercase tracking-wide mb-2">
            ¡Cuenta Vinculada!
          </h1>
          <p class="text-white/60 font-rubik text-sm mb-6">
            Has conectado tu Discord correctamente. Redirigiendo...
          </p>
          <LucideLoader2 size={24} class="animate-spin mx-auto text-white/30" />

          <script is:inline>
            setTimeout(() => window.location.href = "/?discordLinked=true",
            2000);
          </script>
        </div>
      )
    }

    {/* CASO: ERROR - NO MIEMBRO */}
    {
      result.error &&
        result.code === DISCORD_LINK_ERRORS.USER_IS_NOT_MEMBER && (
          <div class="bg-[#0a0a0a] border border-yellow-500/20 rounded-2xl p-8 text-center shadow-2xl">
            <div class="inline-flex p-4 bg-yellow-500/10 rounded-full text-yellow-500 mb-6 border border-yellow-500/20">
              <LucideAlertTriangle size={48} />
            </div>
            <h1 class="text-2xl font-anton text-white uppercase tracking-wide mb-2">
              Acceso Restringido
            </h1>
            <p class="text-white/60 font-rubik text-sm mb-6">
              Debes ser miembro de nuestro servidor de Discord para vincular tu
              cuenta.
            </p>
            <a
              href={discordUrl}
              target="_blank"
              class="block w-full py-3 bg-[#5865F2] hover:bg-[#4752C4] text-white font-bold rounded-xl transition-colors shadow-lg shadow-indigo-500/20"
            >
              Unirse al Servidor
            </a>
            <a
              href="/"
              class="block mt-4 text-xs text-white/30 hover:text-white transition-colors"
            >
              Cancelar y volver
            </a>
          </div>
        )
    }

    {/* CASO: ERROR - YA VINCULADA */}
    {
      result.error &&
        result.code === DISCORD_LINK_ERRORS.DISCORD_ALREADY_LINKED && (
          <div class="bg-[#0a0a0a] border border-red-500/20 rounded-2xl p-8 text-center shadow-2xl">
            <div class="inline-flex p-4 bg-red-500/10 rounded-full text-red-500 mb-6 border border-red-500/20">
              <LucideLink size={48} />
            </div>
            <h1 class="text-2xl font-anton text-white uppercase tracking-wide mb-2">
              Cuenta en Uso
            </h1>
            <p class="text-white/60 font-rubik text-sm mb-6">
              Esta cuenta de Discord ya está vinculada a otro perfil de Salto
              Uruguay.
            </p>
            <a
              href="/usuario"
              class="block w-full py-3 bg-white/10 hover:bg-white/20 text-white font-bold rounded-xl transition-colors"
            >
              Volver a mi Perfil
            </a>
          </div>
        )
    }

    {/* CASO: ERROR GENÉRICO */}
    {
      result.error && result.code === DISCORD_LINK_ERRORS.GENERIC && (
        <div class="bg-[#0a0a0a] border border-red-500/20 rounded-2xl p-8 text-center shadow-2xl">
          <div class="inline-flex p-4 bg-red-500/10 rounded-full text-red-500 mb-6 border border-red-500/20">
            <LucideXCircle size={48} />
          </div>
          <h1 class="text-2xl font-anton text-white uppercase tracking-wide mb-2">
            Error de Conexión
          </h1>
          <p class="text-white/60 font-rubik text-sm mb-6">
            {result.message ||
              "Ocurrió un error inesperado al intentar vincular."}
          </p>
          <a
            href="/"
            class="block w-full py-3 bg-white/10 hover:bg-white/20 text-white font-bold rounded-xl transition-colors"
          >
            Volver al Inicio
          </a>
        </div>
      )
    }
  </div>
</Layout>
