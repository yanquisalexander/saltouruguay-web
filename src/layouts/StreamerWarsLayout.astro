---
import type { Preload } from "@/types/Preload";
import SEO from "@/components/SEO.astro";
import LoadingIndicator from "astro-loading-indicator/component";
import { getSession } from "auth-astro/server";
import { Toaster } from "sonner";
import "@/assets/styles/sonner-styles.css";
import "@/assets/styles/global.css";

import "@fontsource/anton";
import "@fontsource-variable/rubik";
import "@fontsource-variable/teko";
import "@fontsource/press-start-2p";

import anton from "@fontsource/anton/files/anton-latin-400-normal.woff2";
import teko from "@fontsource-variable/teko/files/teko-latin-wght-normal.woff2";
import rubik from "@fontsource-variable/rubik/files/rubik-latin-wght-normal.woff2";

import SignInModal from "@/components/SignInModal.astro";
import KonamiCode from "@/components/KonamiCode.astro";
import { DebugInfo } from "@/components/DebugInfo";
import { ClientRouter } from "astro:transitions";

interface Props {
  title?: string;
  description?: string;
  preload?: Array<Preload>;
  canonical?: string;
  image?: string;
  mainClassname?: string;
}

if (!Astro.props.preload) Astro.props.preload = [];

const {
  title,
  description,
  preload,
  canonical,
  image,
  mainClassname = "streamerwars-layout-base w-full",
} = Astro.props;

const session = await getSession(Astro.request);

preload?.push({
  href: "/favicon.svg",
  as: "image",
  type: "image/svg+xml",
  crossorigin: "anonymous",
});

preload?.push({
  href: anton,
  as: "font",
  type: "font/woff2",
  crossorigin: "anonymous",
});

preload?.push({
  href: teko,
  as: "font",
  type: "font/woff2",
  crossorigin: "anonymous",
});

preload?.push({
  href: rubik,
  as: "font",
  type: "font/woff2",
  crossorigin: "anonymous",
});

preload?.push({
  href: "/fonts/set-sail-studios-atomic-marker-regular.woff2",
  as: "font",
  type: "font/woff2",
  crossorigin: "anonymous",
});
---

<!doctype html>
<html lang="es" class="scroll-smooth bg-[#060109]" data-theme="dark">
  <head>
    <SEO
      title={title}
      description={description}
      image={image}
      canonical={canonical}
      preload={preload}
    />
    <ClientRouter />
    <LoadingIndicator color="#1f97ff" height="3px" />
  </head>
  <body
    class="bg-repeat text-white overflow-x-hidden font-sans bg-[url(https://www.alexitoo.dev/bg.svg)] bg-cover"
  >
    <main class={mainClassname}>
      <div class="appbar justify-center" role="banner">
        <h3
          class="with-glyph flex relative w-max text-xl transform px-2 font-atomic tracking-wider font-bold text-neutral-600 mix-blend-screen"
        >
          <span class="select-none"> Guerra de Streamers </span>
        </h3>
      </div>

      <aside class="sidebar-left" role="complementary">
        <slot name="sidebar-left" />
      </aside>

      <section class="main-content" role="main">
        <slot />
      </section>

      <aside class="sidebar-right" role="complementary">
        <slot name="sidebar-right" />
      </aside>

      <div class="bottom-bar" role="contentinfo">
        <slot name="bottom-bar" />
      </div>
    </main>
    <SignInModal />
    <style is:global>
      :root {
        --app-top-bar-height: 48px;
        --bottombar-height: 32px;
      }

      @font-face {
        font-family: "Atomic Marker";
        font-style: normal;
        font-weight: 100 900;
        font-display: swap;
        src: url("/fonts/set-sail-studios-atomic-marker-regular.woff2")
          format("woff2");
      }

      @font-face {
        font-family: "Atomic Marker Extras";
        font-style: normal;
        font-weight: 100 900;
        font-display: swap;
        src: url("/fonts/set-sail-studios-atomic-marker-extras.woff2")
          format("woff2");
      }
      html {
        font-family: "Jost Variable", system-ui, sans-serif;
      }

      body:has(dialog[open]) {
        @apply overflow-hidden;
      }

      body:has(.hide-scroll-page) {
        @apply overflow-hidden;
      }

      dialog {
        opacity: 0;
        transform: translateY(-5%);
        transition:
          all 0.3s ease-in-out,
          display 0.3s ease allow-discrete;
      }
      dialog::backdrop {
        background-color: rgba(0, 0, 0, 0.5);
      }

      dialog[open] + .dialog-background {
        display: block;
        position: fixed;
      }

      .dialog-background {
        display: none;
      }

      dialog[open] {
        @apply translate-y-0 transition-all duration-500 ease-in-out opacity-100;
        @starting-style {
          transform: translateY(-5%);
          opacity: 0;
        }
      }

      /* StreamerWars layout grid -------------------------------------------------- */
      .streamerwars-layout-base {
        display: grid;
        grid-template-areas:
          "appbar appbar appbar"
          "sidebar-left main sidebar-right"
          "bottom-bar bottom-bar bottom-bar";
        grid-template-columns:
          var(--sidebar-left-width, 64px)
          1fr var(--sidebar-right-width, 64px);
        grid-template-rows:
          [top] var(--app-top-bar-height) [topbarEnd] 1fr [mainEnd] var(
            --bottombar-height
          )
          [end];
        gap: var(--grid-gap, 0);
        height: 100vh;
      }

      .streamerwars-layout-base .appbar {
        grid-area: appbar;
        align-items: center;
        display: flex;
        padding: var(--appbar-padding, 0);
        background: var(--appbar-bg, transparent);
        z-index: 50;
      }

      .streamerwars-layout-base .sidebar-left {
        grid-area: sidebar-left;
        padding: var(--sidebar-padding, 1rem);
        overflow: auto;
        background: var(--sidebar-bg, rgba(0, 0, 0, 0.03));
        min-width: 0;
      }

      .streamerwars-layout-base .sidebar-right {
        grid-area: sidebar-right;
        padding: var(--sidebar-padding, 1rem);
        overflow: auto;
        background: var(--sidebar-bg, rgba(0, 0, 0, 0.03));
        min-width: 0;
      }

      .streamerwars-layout-base .main-content {
        grid-area: main;
        overflow: auto;
        padding: var(--main-padding, 1.25rem);
        min-width: 0;
        @apply border border-neutral-800 rounded-md;

        scrollbar-width: thin;
        scrollbar-color: var(--scrollbar-thumb, #444)
          var(--scrollbar-track, #222);
      }

      .streamerwars-layout-base .bottom-bar {
        grid-area: bottom-bar;
        padding: var(--bottombar-padding, 0);
        height: var(--bottombar-height, 32px);
        background: var(--bottombar-bg, transparent);
      }
    </style>

    <Toaster
      expand={true}
      theme="dark"
      client:only="preact"
      transition:name="global-toast"
      transition:persist
    />

    <KonamiCode />

    <DebugInfo client:load transition:name="debug-info" transition:persist />

    <img
      src="https://librecounter.org/counter.svg"
      referrerpolicy="unsafe-url"
      width="0"
    />
  </body>
</html>
